<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FuelMate</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --app-blue: #00b4db;
            --app-teal: #0083b0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
            /* Native scrolling */
            overflow-y: auto; 
            overflow-x: hidden;
        }

        /* Safe Area Spacing */
        .pt-safe { padding-top: calc(var(--safe-top) + 22px); }
        .pb-safe { padding-bottom: calc(var(--safe-bottom) + 80px); }
        
        /* Sticky Headers */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 40;
            padding-top: var(--safe-top);
            background: rgba(243, 244, 246, 0.95);
            backdrop-filter: blur(10px);
        }

        /* Gradient Text */
        .text-gradient {
            background: linear-gradient(to right, var(--app-blue), var(--app-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Card Styles */
        .card-shadow { 
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* Floating Action Button */
        .fab-shadow { box-shadow: 0 4px 15px rgba(0, 180, 219, 0.4); }
    </style>
    <script>
        // Dynamic Icon Generator
        (function() {
            const size = 512;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // Background Gradient
            const grd = ctx.createLinearGradient(0, 0, size, size);
            grd.addColorStop(0, '#00b4db');
            grd.addColorStop(1, '#0083b0');
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, size, size);

            // Icon (Gas Pump)
            ctx.fillStyle = 'white';
            ctx.font = 'bold 300px Material Icons';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('local_gas_station', size/2, size/2);

            const dataUrl = canvas.toDataURL('image/png');

            // Inject Link
            const link = document.createElement('link');
            link.rel = 'apple-touch-icon';
            link.href = dataUrl;
            document.head.appendChild(link);

            // Dynamic Manifest
            const manifest = {
                name: "FuelMate",
                short_name: "FuelMate",
                start_url: ".",
                display: "standalone",
                background_color: "#f3f4f6",
                theme_color: "#0083b0",
                icons: [{ src: dataUrl, sizes: "512x512", type: "image/png" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestUrl = URL.createObjectURL(blob);
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = manifestUrl;
            document.head.appendChild(manifestLink);
        })();
    </script>
</head>
<body class="text-slate-700">

    <div id="app" class="min-h-screen pb-safe">
        <!-- Dynamic Content -->
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-lg border-t border-slate-100 flex justify-around items-center pb-[env(safe-area-inset-bottom)] pt-2 z-50" style="padding-bottom: max(10px, env(safe-area-inset-bottom));">
        <button onclick="router.navigate('dashboard')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="dashboard">
            <span class="material-icons text-2xl mb-0.5">dashboard</span>
            <span class="text-[10px] font-medium t-dash">Dash</span>
        </button>
        <button onclick="router.navigate('fuel')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="fuel">
            <span class="material-icons text-2xl mb-0.5">local_gas_station</span>
            <span class="text-[10px] font-medium t-fuel">Fuel</span>
        </button>
         <button onclick="router.navigate('parking')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="parking">
            <span class="material-icons text-2xl mb-0.5">local_parking</span>
            <span class="text-[10px] font-medium t-parking">Park</span>
        </button>
        <button onclick="router.navigate('maintenance')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="maintenance">
            <span class="material-icons text-2xl mb-0.5">build</span>
            <span class="text-[10px] font-medium t-service">Service+</span>
        </button>
        <button onclick="router.navigate('analytics')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="analytics">
            <span class="material-icons text-2xl mb-0.5">pie_chart</span>
            <span class="text-[10px] font-medium t-analytics">Analytics</span>
        </button>
        <button onclick="router.navigate('settings')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="settings">
            <span class="material-icons text-2xl mb-0.5">settings</span>
            <span class="text-[10px] font-medium t-settings">Settings</span>
        </button>
    </nav>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-3xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300 overflow-hidden max-h-[90vh] overflow-y-auto">
            <!-- Modal Content Injected Here -->
        </div>
    </div>

    <script>
        /* --- TRANSLATIONS --- */
        const translations = {
            en: {
                t_dash: "Dash", t_fuel: "Fuel", t_service: "Service+", t_parking: "Park", t_analytics: "Analytics", t_settings: "Settings",
                welcome: "Welcome to FuelMate", no_vehicle: "No vehicle added", add_first: "Add your first vehicle to get started",
                add_vehicle: "Add Vehicle", edit_vehicle: "Edit Vehicle", select_vehicle: "Select Vehicle",
                this_month: "This Month", this_year: "This Year", all_time: "All Time",
                efficiency: "EFFICIENCY", cost_km: "COST/KM", total_cost: "TOTAL COST", total_distance: "TOTAL DISTANCE",
                reminders: "Reminders", expiring_soon: "Expiring Soon", expired: "Expired", days_left: "days left",
                add_fuel: "Add Fuel", add_service: "Add Service",
                recent_activity: "RECENT ACTIVITY", no_records: "No records yet",
                date: "DATE", odometer: "ODOMETER", liters: "LITERS", gallons: "GALLONS", cost: "COST", price_unit: "PRICE/UNIT",
                fuel_type: "FUEL TYPE", location: "LOCATION", notes: "NOTES", type: "TYPE",
                save: "Save", cancel: "Cancel", delete: "Delete", edit: "Edit", clear_history: "Clear History",
                confirm_delete: "Are you sure you want to delete this record?",
                confirm_clear_1: "WARNING: This will delete ALL Fuel, Service, and Parking logs for this vehicle.",
                confirm_clear_2: "Are you absolutely sure? This cannot be undone.",
                settings_title: "Settings", manage_vehicles: "Manage Vehicles", app_settings: "App Settings",
                units: "Units", currency: "Currency", language: "Language",
                export_json: "Export Data (JSON)", import_json: "Import Data (JSON)",
                import_success: "Data imported successfully!", import_error: "Invalid JSON file.",
                confirm_overwrite: "WARNING: This will overwrite all current data. Are you sure?",
                license_renewal: "License Renewal", insurance_renewal: "Insurance Renewal", registration: "Vehicle Registration",
                new_expiry: "NEW EXPIRY DATE", detect_loc: "Detect",
                parking_cost: "PARKING COST", service_cost: "SERVICE COST", fixed_costs: "FIXED COSTS",
                maintenance: "Maintenance"
            },
            zh: {
                t_dash: "首頁", t_fuel: "加油", t_service: "維修/其他", t_parking: "停車", t_analytics: "統計", t_settings: "設定",
                welcome: "歡迎使用 FuelMate", no_vehicle: "尚未添加車輛", add_first: "添加您的第一輛車以開始使用",
                add_vehicle: "新增車輛", edit_vehicle: "編輯車輛", select_vehicle: "選擇車輛",
                this_month: "本月", this_year: "今年", all_time: "全部",
                efficiency: "油耗表現", cost_km: "每公里成本", total_cost: "總支出", total_distance: "總里程",
                reminders: "提醒通知", expiring_soon: "即將到期", expired: "已過期", days_left: "天後到期",
                add_fuel: "新增加油", add_service: "新增維修",
                recent_activity: "近期活動", no_records: "等待更多記錄",
                date: "日期", odometer: "里程", liters: "公升", gallons: "加侖", cost: "金額", price_unit: "單價",
                fuel_type: "燃油種類", location: "地點", notes: "備註", type: "類型",
                save: "保存", cancel: "取消", delete: "刪除", edit: "編輯", clear_history: "清除所有紀錄",
                confirm_delete: "確定要刪除此記錄嗎？",
                confirm_clear_1: "警告：這將刪除此車輛的所有加油、維修和停車記錄。",
                confirm_clear_2: "您確定要繼續嗎？此操作無法撤銷。",
                settings_title: "設定", manage_vehicles: "車輛管理", app_settings: "應用設定",
                units: "單位", currency: "貨幣", language: "語言",
                export_json: "匯出資料 (JSON)", import_json: "匯入資料 (JSON)",
                import_success: "資料匯入成功！", import_error: "無效的 JSON 文件。",
                confirm_overwrite: "警告：這將覆蓋當前所有數據。您確定要繼續嗎？",
                license_renewal: "車牌續期", insurance_renewal: "保險續期", registration: "車輛登記",
                new_expiry: "新到期日", detect_loc: "定位",
                parking_cost: "停車總支出", service_cost: "維修總支出", fixed_costs: "固定支出 (牌照/保險)",
                maintenance: "維修保養/牌照"
            }
        };

        /* --- STORE --- */
        const store = {
            data: {
                vehicles: [],
                logs: [],
                settings: { activeVehicleId: null, units: 'metric', currency: '$', language: 'en' }
            },
            pageFilters: {
                fuel: 'month',
                maintenance: 'month',
                parking: 'month'
            },
            init() {
                const saved = localStorage.getItem('fuelmate_data');
                if (saved) this.data = JSON.parse(saved);
                // Migration: ensure settings has language
                if (!this.data.settings.language) this.data.settings.language = 'en';
            },
            save() {
                localStorage.setItem('fuelmate_data', JSON.stringify(this.data));
                ui.render();
            },
            addVehicle(vehicle) {
                this.data.vehicles.push(vehicle);
                if (!this.data.settings.activeVehicleId) this.data.settings.activeVehicleId = vehicle.id;
                this.save();
            },
            updateVehicle(vehicle) {
                const idx = this.data.vehicles.findIndex(v => v.id === vehicle.id);
                if (idx !== -1) {
                    this.data.vehicles[idx] = vehicle;
                    this.save();
                }
            },
            deleteVehicle(id) {
                this.data.vehicles = this.data.vehicles.filter(v => v.id !== id);
                this.data.logs = this.data.logs.filter(l => l.vehicleId !== id);
                if (this.data.settings.activeVehicleId === id) {
                    this.data.settings.activeVehicleId = this.data.vehicles.length > 0 ? this.data.vehicles[0].id : null;
                }
                this.save();
            },
            clearVehicleLogs(vid) {
                this.data.logs = this.data.logs.filter(l => l.vehicleId !== vid);
                this.save();
            },
            addLog(log) {
                this.data.logs.push(log);
                // Update vehicle odometer if higher
                const vehicle = this.getActiveVehicle();
                if (vehicle && log.odometer > vehicle.currentOdometer) {
                    vehicle.currentOdometer = parseInt(log.odometer);
                }
                this.save();
            },
            updateLog(log) {
                const idx = this.data.logs.findIndex(l => l.id === log.id);
                if (idx !== -1) {
                    this.data.logs[idx] = log;
                    // Re-check odometer
                    const vehicle = this.getActiveVehicle();
                    const maxOdo = Math.max(...this.data.logs.filter(l => l.vehicleId === vehicle.id).map(l => parseInt(l.odometer) || 0));
                    vehicle.currentOdometer = maxOdo;
                    this.save();
                }
            },
            deleteLog(id) {
                this.data.logs = this.data.logs.filter(l => l.id !== id);
                this.save();
            },
            getActiveVehicle() {
                return this.data.vehicles.find(v => v.id === this.data.settings.activeVehicleId);
            },
            getVehicleLogs(type = null) {
                let logs = this.data.logs.filter(l => l.vehicleId === this.data.settings.activeVehicleId);
                if (type) {
                    if (type === 'maintenance') {
                        // Maintenance includes repairs, license, insurance, registration
                        return logs.filter(l => ['maintenance', 'license', 'insurance', 'registration'].includes(l.type));
                    }
                    return logs.filter(l => l.type === type);
                }
                return logs.sort((a, b) => new Date(b.date) - new Date(a.date));
            }
        };

        /* --- UTILS --- */
        const utils = {
            t(key) {
                const lang = store.data.settings.language || 'en';
                return translations[lang][key] || key;
            },
            uuid() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            formatCurrency(amount) {
                return `${store.data.settings.currency}${parseFloat(amount).toFixed(2)}`;
            },
            formatDate(dateStr) {
                const date = new Date(dateStr);
                const lang = store.data.settings.language;
                if (lang === 'zh') {
                    return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
                }
                return date.toLocaleDateString('en-GB'); // DD/MM/YYYY
            },
            calculateStats(range, category = 'all') {
                const logs = store.getVehicleLogs(); // Get all logs for vehicle
                const now = new Date();
                let filtered = logs;

                // 1. Date Filter
                if (range === 'month') {
                    filtered = logs.filter(l => {
                        const d = new Date(l.date);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    });
                } else if (range === 'year') {
                    filtered = logs.filter(l => new Date(l.date).getFullYear() === now.getFullYear());
                }

                // 2. Category Filter
                if (category === 'fuel') {
                    filtered = filtered.filter(l => l.type === 'fuel');
                } else if (category === 'maintenance') {
                    filtered = filtered.filter(l => ['maintenance', 'license', 'insurance', 'registration'].includes(l.type));
                } else if (category === 'parking') {
                    filtered = filtered.filter(l => l.type === 'parking');
                }
                // 'all' includes everything

                const totalCost = filtered.reduce((sum, l) => sum + parseFloat(l.cost || 0), 0);
                
                // Distance calculation (Log based)
                let totalDist = 0;
                if (filtered.length > 1) {
                    const sorted = [...filtered].sort((a, b) => a.odometer - b.odometer);
                    const min = sorted[0].odometer;
                    const max = sorted[sorted.length - 1].odometer;
                    totalDist = max - min;
                }

                // Fuel Efficiency (Simple avg)
                let efficiency = 0;
                let costPerKm = 0;
                
                if (category === 'fuel' || category === 'all') {
                    const fuelLogs = filtered.filter(l => l.type === 'fuel').sort((a,b) => a.odometer - b.odometer);
                    if (fuelLogs.length > 1) {
                        let totalFuel = 0;
                        let dist = fuelLogs[fuelLogs.length-1].odometer - fuelLogs[0].odometer;
                        // Sum fuel excluding the first one (as it starts the period) or simple sum? 
                        // Simple sum for chart is okay, but for exact L/100km we usually need span.
                        // Let's use: Sum(Liters) / Sum(Dist)
                        for(let i=0; i<fuelLogs.length-1; i++){
                             totalFuel += parseFloat(fuelLogs[i].liters);
                        }
                         // Simplified: Total Liters / Total Dist * 100
                         // Use full sum for expense, but for efficiency use span
                        const vol = fuelLogs.reduce((a,b)=>a+parseFloat(b.liters),0);
                        if(dist > 0) {
                            efficiency = (vol / dist) * 100;
                            costPerKm = totalCost / dist;
                        }
                    }
                }
                
                if (category !== 'fuel' && totalDist > 0) {
                     costPerKm = totalCost / totalDist;
                }

                return { totalCost, totalDist, efficiency, costPerKm };
            },
            filterLogs(logs, range) {
                const now = new Date();
                if (range === 'month') {
                    return logs.filter(l => {
                        const d = new Date(l.date);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    });
                }
                if (range === 'year') {
                    return logs.filter(l => new Date(l.date).getFullYear() === now.getFullYear());
                }
                return logs;
            },
            exportCalendar() {
                const vehicle = store.getActiveVehicle();
                if(!vehicle) return;
                const logs = store.getVehicleLogs().filter(l => ['license', 'insurance', 'registration'].includes(l.type) && l.expiryDate);
                
                // Find latest expiry for each type
                const latest = {};
                logs.forEach(l => {
                    if (!latest[l.type] || new Date(l.expiryDate) > new Date(latest[l.type].expiryDate)) {
                        latest[l.type] = l;
                    }
                });

                let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//FuelMate//EN\n";
                Object.values(latest).forEach(l => {
                    const date = l.expiryDate.replace(/-/g, '');
                    const title = utils.t(l.type === 'license' ? 'license_renewal' : (l.type === 'insurance' ? 'insurance_renewal' : 'registration')) + ` - ${vehicle.make}`;
                    icsContent += "BEGIN:VEVENT\n";
                    icsContent += `DTSTART;VALUE=DATE:${date}\n`;
                    icsContent += `SUMMARY:${title}\n`;
                    icsContent += `DESCRIPTION:Vehicle: ${vehicle.make} ${vehicle.model}\n`;
                    icsContent += "END:VEVENT\n";
                });
                icsContent += "END:VCALENDAR";

                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'vehicle_reminders.ics';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        /* --- UI RENDERER --- */
        const ui = {
            currentPage: 'dashboard',
            
            render() {
                const app = document.getElementById('app');
                const vehicle = store.getActiveVehicle();
                
                // Highlight Nav
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const active = btn.dataset.page === this.currentPage;
                    btn.className = `nav-btn p-2 flex flex-col items-center transition duration-300 ${active ? 'text-sky-600' : 'text-slate-400'}`;
                });

                if (!vehicle && this.currentPage !== 'settings') {
                    app.innerHTML = this.renderNoVehicleState();
                    return;
                }

                if (this.currentPage === 'dashboard') this.renderDashboard(app, vehicle);
                else if (this.currentPage === 'fuel') this.renderFuel(app, vehicle);
                else if (this.currentPage === 'maintenance') this.renderMaintenance(app, vehicle);
                else if (this.currentPage === 'parking') this.renderParking(app, vehicle);
                else if (this.currentPage === 'analytics') this.renderAnalytics(app, vehicle);
                else if (this.currentPage === 'settings') this.renderSettings(app);
            },

            renderNoVehicleState() {
                return `
                    <div class="h-screen flex flex-col items-center justify-center p-8 text-center">
                        <div class="w-24 h-24 bg-sky-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                            <span class="material-icons text-5xl text-sky-600">directions_car</span>
                        </div>
                        <h2 class="text-2xl font-bold mb-2 text-slate-800">${utils.t('welcome')}</h2>
                        <p class="text-slate-500 mb-8">${utils.t('add_first')}</p>
                        <button onclick="ui.openAddVehicle()" class="bg-sky-500 text-white px-8 py-3 rounded-2xl shadow-lg shadow-sky-200 font-semibold active:scale-95 transition transform">
                            ${utils.t('add_vehicle')}
                        </button>
                    </div>
                `;
            },

            renderDashboard(container, vehicle) {
                // 1. Calculate Stats
                const stats = utils.calculateStats('month', 'all'); // Month stats for dashboard top
                
                // 2. Reminders
                const logs = store.getVehicleLogs();
                const reminderTypes = ['license', 'insurance', 'registration'];
                const reminders = [];
                
                reminderTypes.forEach(type => {
                    const typeLogs = logs.filter(l => l.type === type && l.expiryDate);
                    if (typeLogs.length > 0) {
                        // Get latest
                        const latest = typeLogs.sort((a,b) => new Date(b.expiryDate) - new Date(a.expiryDate))[0];
                        const days = Math.ceil((new Date(latest.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (days <= 30) {
                            reminders.push({ ...latest, days });
                        }
                    }
                });

                // 3. Recent Activity
                const recentLogs = store.getVehicleLogs().slice(0, 5);

                container.innerHTML = `
                    <!-- Header -->
                    <div class="bg-gradient-to-br from-cyan-500 to-blue-600 pb-8 rounded-b-[2.5rem] shadow-xl relative overflow-hidden">
                         <!-- Decorative Circles -->
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                        <div class="absolute bottom-0 left-0 w-48 h-48 bg-black/5 rounded-full -ml-10 -mb-10 blur-2xl"></div>

                        <div class="flex justify-between items-start pt-safe px-6 pb-12 text-white relative z-10">
                            <div class="flex-1">
                                <div class="text-sm opacity-80 font-medium tracking-wider mb-1">${vehicle.year} ${vehicle.make}</div>
                                <button onclick="ui.openVehicleSelector()" class="text-3xl font-bold flex items-center gap-2">
                                    ${vehicle.model}
                                    <span class="material-icons text-2xl opacity-80">expand_circle_down</span>
                                </button>
                            </div>
                             <div class="flex gap-2">
                                <button onclick="utils.exportCalendar()" class="bg-white/20 w-10 h-10 flex items-center justify-center rounded-full backdrop-blur-sm hover:bg-white/30 transition">
                                    <span class="material-icons text-white text-xl">event</span>
                                </button>
                                <button onclick="ui.openAddVehicle('${vehicle.id}')" class="bg-white/20 w-10 h-10 flex items-center justify-center rounded-full backdrop-blur-sm hover:bg-white/30 transition">
                                    <span class="material-icons text-white text-xl">edit</span>
                                </button>
                            </div>
                        </div>

                        <!-- Time Filter Pills -->
                         <div class="absolute bottom-6 left-0 w-full flex justify-center z-20">
                             <div class="bg-black/20 backdrop-blur-md p-1 rounded-full flex text-xs font-medium">
                                 <button onclick="store.dashboardFilter='month';ui.render()" class="${store.dashboardFilter==='month'?'bg-white text-sky-600 shadow-sm':'text-white/80 hover:bg-white/10'} px-4 py-1.5 rounded-full transition-all">${utils.t('this_month')}</button>
                                 <button onclick="store.dashboardFilter='year';ui.render()" class="${store.dashboardFilter==='year'?'bg-white text-sky-600 shadow-sm':'text-white/80 hover:bg-white/10'} px-4 py-1.5 rounded-full transition-all">${utils.t('this_year')}</button>
                                 <button onclick="store.dashboardFilter='all';ui.render()" class="${store.dashboardFilter==='all'?'bg-white text-sky-600 shadow-sm':'text-white/80 hover:bg-white/10'} px-4 py-1.5 rounded-full transition-all">${utils.t('all_time')}</button>
                             </div>
                         </div>
                    </div>

                    <div class="px-4 mt-2 relative z-30 space-y-4 pb-24">
                        
                        <!-- Reminders -->
                        ${reminders.length > 0 ? `
                            <div class="bg-orange-50 border-l-4 border-orange-500 rounded-xl p-4 card-shadow mb-4">
                                <div class="flex items-center gap-2 mb-2 text-orange-700 font-bold text-sm uppercase">
                                    <span class="material-icons text-lg">notifications_active</span>
                                    ${utils.t('reminders')}
                                </div>
                                ${reminders.map(r => `
                                    <div class="flex justify-between items-center text-sm py-1 border-b border-orange-100 last:border-0">
                                        <span class="text-slate-700">${utils.t(r.type === 'license' ? 'license_renewal' : (r.type === 'insurance' ? 'insurance_renewal' : 'registration'))}</span>
                                        <span class="${r.days < 0 ? 'text-red-600 font-bold' : (r.days < 15 ? 'text-orange-600 font-bold' : 'text-green-600')}">
                                            ${r.days < 0 ? utils.t('expired') : `${r.days} ${utils.t('days_left')}`}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- Stats Grid -->
                        ${this.renderStatsGrid(store.dashboardFilter || 'month', 'all')}

                        <!-- Quick Actions -->
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <button onclick="ui.openAddFuel()" class="bg-teal-600 text-white p-4 rounded-2xl shadow-lg shadow-teal-200 flex flex-col items-center justify-center gap-2 active:scale-95 transition transform">
                                <span class="material-icons text-3xl">local_gas_station</span>
                                <span class="font-semibold">${utils.t('add_fuel')}</span>
                            </button>
                            <button onclick="ui.openAddService()" class="bg-white text-slate-600 p-4 rounded-2xl card-shadow flex flex-col items-center justify-center gap-2 active:scale-95 transition transform">
                                <span class="material-icons text-3xl text-slate-400">build</span>
                                <span class="font-semibold">${utils.t('add_service')}</span>
                            </button>
                        </div>

                        <!-- Recent Activity -->
                        <div class="mt-6">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">${utils.t('recent_activity')}</h3>
                            ${recentLogs.length === 0 ? `<p class="text-center text-slate-400 text-sm py-4 italic">${utils.t('no_records')}</p>` : 
                                `<div class="space-y-3">
                                    ${recentLogs.map(log => this.renderLogCard(log)).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                `;
            },

            renderStatsGrid(range, category) {
                const s = utils.calculateStats(range, category);
                const units = store.data.settings.units;
                
                return `
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl card-shadow">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">${utils.t(category === 'all' || category === 'fuel' ? 'efficiency' : 'cost')}</div>
                            <div class="text-xl font-bold text-slate-700 truncate">
                                ${category === 'all' || category === 'fuel' 
                                    ? (s.efficiency > 0 ? (units === 'metric' ? s.efficiency.toFixed(1) : (235.215/s.efficiency).toFixed(1)) : '--') 
                                    : utils.formatCurrency(s.totalCost)}
                            </div>
                            <div class="text-[10px] text-slate-400">${category === 'all' || category === 'fuel' ? (units === 'metric' ? 'L/100km' : 'MPG') : ''}</div>
                        </div>
                        <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl card-shadow">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">${utils.t('cost_km')}</div>
                            <div class="text-xl font-bold text-slate-700 truncate">
                                ${s.costPerKm > 0 ? utils.formatCurrency(s.costPerKm) : '--'}
                            </div>
                            <div class="text-[10px] text-slate-400">/${units === 'metric' ? 'km' : 'mi'}</div>
                        </div>
                        <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl card-shadow">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">${utils.t('total_cost')}</div>
                            <div class="text-xl font-bold text-slate-700 truncate">${utils.formatCurrency(s.totalCost)}</div>
                        </div>
                         <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl card-shadow">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">${utils.t('total_distance')}</div>
                            <div class="text-xl font-bold text-slate-700 truncate">${s.totalDist.toLocaleString()}</div>
                             <div class="text-[10px] text-slate-400">${units === 'metric' ? 'km' : 'mi'}</div>
                        </div>
                    </div>
                `;
            },

            renderFuel(container, vehicle) {
                this.renderListPage(container, vehicle, 'fuel', 'local_gas_station', 'bg-teal-500', utils.t('t_fuel'));
            },

            renderMaintenance(container, vehicle) {
                 this.renderListPage(container, vehicle, 'maintenance', 'build', 'bg-indigo-500', utils.t('maintenance'));
            },

            renderParking(container, vehicle) {
                this.renderListPage(container, vehicle, 'parking', 'local_parking', 'bg-blue-500', utils.t('t_parking'));
            },

            renderListPage(container, vehicle, type, icon, bgClass, title) {
                const range = store.pageFilters[type];
                const allLogs = store.getVehicleLogs(type);
                const filteredLogs = utils.filterLogs(allLogs, range);
                
                // Render Header Stats specific to this page
                let statsHtml = '';
                if (type === 'fuel') {
                    statsHtml = this.renderStatsGrid(range, 'fuel');
                } else {
                     // Simplified stats for parking/maintenance
                     const s = utils.calculateStats(range, type);
                     statsHtml = `
                        <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl card-shadow mb-4 flex justify-between items-center">
                             <div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">${utils.t(type === 'parking' ? 'parking_cost' : 'service_cost')}</div>
                                <div class="text-2xl font-bold text-slate-700">${utils.formatCurrency(s.totalCost)}</div>
                             </div>
                             <div class="h-10 w-10 rounded-full ${bgClass} bg-opacity-20 flex items-center justify-center">
                                <span class="material-icons text-${bgClass.replace('bg-', '')} text-xl">${icon}</span>
                             </div>
                        </div>
                     `;
                }

                container.innerHTML = `
                    <div class="sticky-header px-4 pb-4 shadow-sm flex justify-between items-center">
                         <div class="flex items-center gap-3">
                             <span class="material-icons text-3xl text-slate-700">${icon}</span>
                             <h1 class="text-2xl font-bold text-slate-800">${title}</h1>
                         </div>
                         <div class="bg-slate-200 p-1 rounded-full flex text-[10px] font-bold">
                             ${['month', 'year', 'all'].map(r => `
                                <button onclick="store.pageFilters['${type}']='${r}';ui.render()" 
                                    class="${range===r ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500'} px-3 py-1 rounded-full transition-all uppercase">
                                    ${utils.t(r === 'month' ? 'this_month' : (r === 'year' ? 'this_year' : 'all_time'))}
                                </button>
                             `).join('')}
                         </div>
                    </div>
                    
                    <div class="px-4 py-4 pb-24">
                        ${statsHtml}
                        <div class="space-y-3 mt-4">
                            ${filteredLogs.length === 0 ? `<p class="text-center text-slate-400 mt-10 italic">${utils.t('no_records')}</p>` : 
                                filteredLogs.map(log => this.renderLogCard(log)).join('')}
                        </div>
                    </div>
                    
                    <button onclick="${type==='fuel'?'ui.openAddFuel()':'ui.openAddService(null, \''+type+'\')'}" class="fixed bottom-24 right-6 w-14 h-14 ${bgClass} rounded-full text-white shadow-xl flex items-center justify-center hover:scale-105 transition fab-shadow">
                        <span class="material-icons text-3xl">add</span>
                    </button>
                `;
            },

            renderLogCard(log) {
                const isFuel = log.type === 'fuel';
                const icon = log.type === 'fuel' ? 'local_gas_station' : (log.type === 'parking' ? 'local_parking' : 'build');
                const color = log.type === 'fuel' ? 'text-teal-600 bg-teal-50' : (log.type === 'parking' ? 'text-blue-600 bg-blue-50' : 'text-indigo-600 bg-indigo-50');
                
                // Calculations for fuel log
                let fuelStats = '';
                if (isFuel) {
                    // Find previous log to calc efficiency
                    const logs = store.getVehicleLogs('fuel');
                    const idx = logs.findIndex(l => l.id === log.id);
                    if (idx !== -1 && idx < logs.length - 1) {
                        const prev = logs[idx+1]; // Logs are sorted desc
                        const dist = log.odometer - prev.odometer;
                        const l100 = (log.liters / dist) * 100;
                        const ckm = log.cost / dist;
                        const units = store.data.settings.units;
                        
                        fuelStats = `
                            <div class="mt-3 pt-3 border-t border-slate-100 flex justify-around text-center">
                                <div>
                                    <div class="text-[10px] text-slate-400 uppercase">L/100km</div>
                                    <div class="text-sm font-bold text-teal-600">${l100.toFixed(1)}</div>
                                </div>
                                ${units === 'imperial' ? `
                                <div>
                                    <div class="text-[10px] text-slate-400 uppercase">MPG</div>
                                    <div class="text-sm font-bold text-teal-600">${(235.215/l100).toFixed(1)}</div>
                                </div>` : ''}
                                <div>
                                    <div class="text-[10px] text-slate-400 uppercase">$/km</div>
                                    <div class="text-sm font-bold text-teal-600">${ckm.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-[10px] text-slate-400 uppercase">+km</div>
                                    <div class="text-[10px] text-slate-400 mt-1">+${dist}</div>
                                </div>
                            </div>
                        `;
                    } else {
                         fuelStats = `<div class="mt-2 text-center text-xs text-slate-300 italic">${utils.t('no_records')}</div>`;
                    }
                }

                let title = isFuel ? utils.t('add_fuel') : (log.type === 'parking' ? utils.t('t_parking') : (log.notes || utils.t('add_service')));
                // Override title for license/insurance types
                if (['license', 'insurance', 'registration'].includes(log.type)) {
                    title = utils.t(log.type === 'license' ? 'license_renewal' : (log.type === 'insurance' ? 'insurance_renewal' : 'registration'));
                }

                return `
                    <div class="bg-white p-4 rounded-2xl card-shadow relative group">
                        <button onclick="ui.openAddService('${log.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-sky-500 transition">
                             <span class="material-icons text-lg">edit</span>
                        </button>
                        <div class="flex items-start gap-4">
                            <div class="w-10 h-10 rounded-full ${color} flex items-center justify-center shrink-0">
                                <span class="material-icons text-lg">${icon}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start pr-8">
                                    <h4 class="font-bold text-slate-700 truncate">${title}</h4>
                                    <span class="font-bold text-slate-800 text-lg">${utils.formatCurrency(log.cost)}</span>
                                </div>
                                <div class="text-xs text-slate-400 mb-1">${utils.formatDate(log.date)} • ${parseInt(log.odometer).toLocaleString()} km</div>
                                ${log.pricePerUnit ? `<div class="text-xs text-slate-400">${log.liters}L @ ${log.pricePerUnit}/L</div>` : ''}
                                ${log.location ? `<div class="text-xs text-slate-500 flex items-center gap-1 mt-1"><span class="material-icons text-[10px]">place</span> ${log.location}</div>` : ''}
                                ${log.expiryDate ? `<div class="text-xs text-orange-500 font-bold mt-1">${utils.t('new_expiry')}: ${log.expiryDate}</div>` : ''}
                            </div>
                        </div>
                        ${fuelStats}
                    </div>
                `;
            },

            renderAnalytics(container, vehicle) {
                const s = utils.calculateStats('year', 'all'); // Year overview
                
                // Calc Fixed Costs
                const fixedLogs = store.getVehicleLogs().filter(l => ['license', 'insurance', 'registration'].includes(l.type));
                const fixedCost = fixedLogs.reduce((sum, l) => sum + parseFloat(l.cost || 0), 0); // Total All time? Or year? Let's do year for chart
                // Filter fixed for year
                const now = new Date();
                const yearlyFixed = fixedLogs.filter(l => new Date(l.date).getFullYear() === now.getFullYear()).reduce((s,l)=>s+parseFloat(l.cost),0);

                // Render Charts
                // Pie Data: Fuel vs Maintenance vs Parking vs Fixed
                const fuelCost = utils.calculateStats('year', 'fuel').totalCost;
                const parkingCost = utils.calculateStats('year', 'parking').totalCost;
                const maintCost = utils.calculateStats('year', 'maintenance').totalCost - yearlyFixed; // Pure maintenance

                const total = fuelCost + parkingCost + maintCost + yearlyFixed;
                const pFuel = total ? (fuelCost/total)*100 : 0;
                const pPark = total ? (parkingCost/total)*100 : 0;
                const pMaint = total ? (maintCost/total)*100 : 0;
                const pFixed = total ? (yearlyFixed/total)*100 : 0;

                // SVG Pie Chart
                const createSlice = (percent, color, offset) => {
                    if(percent === 0) return '';
                    const x = Math.cos(2 * Math.PI * offset);
                    const y = Math.sin(2 * Math.PI * offset);
                    const endX = Math.cos(2 * Math.PI * (offset + percent/100));
                    const endY = Math.sin(2 * Math.PI * (offset + percent/100));
                    const largeArc = percent > 50 ? 1 : 0;
                    return `<path d="M 0 0 L ${x} ${y} A 1 1 0 ${largeArc} 1 ${endX} ${endY} Z" fill="${color}"/>`;
                };
                
                let offset = 0;
                const sliceFuel = createSlice(pFuel, '#14b8a6', offset); offset += pFuel/100;
                const slicePark = createSlice(pPark, '#3b82f6', offset); offset += pPark/100;
                const sliceMaint = createSlice(pMaint, '#6366f1', offset); offset += pMaint/100;
                const sliceFixed = createSlice(pFixed, '#f59e0b', offset);

                container.innerHTML = `
                    <div class="sticky-header px-4 pb-4 shadow-sm">
                        <h1 class="text-2xl font-bold text-slate-800 pt-4">${utils.t('t_analytics')}</h1>
                    </div>
                    <div class="p-4 pb-24 space-y-6">
                        
                        <!-- Pie Chart -->
                        <div class="bg-white p-6 rounded-3xl card-shadow text-center">
                            <h3 class="text-sm font-bold text-slate-400 uppercase mb-6">${utils.t('total_cost')} (${new Date().getFullYear()})</h3>
                            <div class="w-48 h-48 mx-auto relative">
                                <svg viewBox="-1 -1 2 2" class="transform -rotate-90 w-full h-full overflow-visible">
                                    ${total === 0 ? '<circle cx="0" cy="0" r="1" fill="#f1f5f9"/>' : 
                                    sliceFuel + slicePark + sliceMaint + sliceFixed}
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                                    <span class="text-2xl font-bold text-slate-700">${utils.formatCurrency(total)}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-8 text-left">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-teal-500"></div>
                                    <div class="text-xs text-slate-500">Fuel (${Math.round(pFuel)}%)</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                    <div class="text-xs text-slate-500">Parking (${Math.round(pPark)}%)</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
                                    <div class="text-xs text-slate-500">Service (${Math.round(pMaint)}%)</div>
                                </div>
                                 <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                                    <div class="text-xs text-slate-500">Fixed (${Math.round(pFixed)}%)</div>
                                </div>
                            </div>
                        </div>

                         <div class="bg-white p-6 rounded-3xl card-shadow">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-sm font-bold text-slate-400 uppercase">${utils.t('fixed_costs')}</h3>
                                <span class="text-amber-500 font-bold">${utils.formatCurrency(yearlyFixed)}</span>
                            </div>
                             <div class="space-y-2">
                                 ${fixedLogs.slice(0,3).map(l => `
                                     <div class="flex justify-between text-sm py-2 border-b border-slate-50">
                                         <span class="text-slate-600">${utils.t(l.type === 'license' ? 'license_renewal' : (l.type === 'insurance' ? 'insurance_renewal' : 'registration'))}</span>
                                         <span>${utils.formatCurrency(l.cost)}</span>
                                     </div>
                                 `).join('')}
                             </div>
                         </div>

                    </div>
                `;
            },

            renderSettings(container) {
                const settings = store.data.settings;
                container.innerHTML = `
                    <div class="sticky-header px-4 pb-4 shadow-sm">
                        <h1 class="text-2xl font-bold text-slate-800 pt-4">${utils.t('settings_title')}</h1>
                    </div>
                    <div class="p-4 pb-24 space-y-6">
                        
                        <div class="bg-white rounded-2xl card-shadow overflow-hidden">
                            <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-bold text-slate-500 text-xs uppercase">${utils.t('manage_vehicles')}</div>
                            ${store.data.vehicles.map(v => `
                                <div class="p-4 flex justify-between items-center border-b border-slate-100 last:border-0 cursor-pointer active:bg-slate-50" onclick="store.data.settings.activeVehicleId='${v.id}';store.save();ui.render()">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full ${v.id === settings.activeVehicleId ? 'bg-sky-500 text-white' : 'bg-slate-200 text-slate-500'} flex items-center justify-center">
                                            <span class="material-icons">directions_car</span>
                                        </div>
                                        <div>
                                            <div class="font-bold text-slate-700">${v.model}</div>
                                            <div class="text-xs text-slate-400">${v.year} ${v.make}</div>
                                        </div>
                                    </div>
                                    <button onclick="event.stopPropagation();ui.openAddVehicle('${v.id}')" class="text-slate-300 hover:text-sky-500 p-2">
                                        <span class="material-icons">edit</span>
                                    </button>
                                </div>
                            `).join('')}
                            <button onclick="ui.openAddVehicle()" class="w-full py-4 text-center text-sky-600 font-bold text-sm hover:bg-sky-50 transition">
                                + ${utils.t('add_vehicle')}
                            </button>
                        </div>

                        <div class="bg-white rounded-2xl card-shadow overflow-hidden">
                            <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-bold text-slate-500 text-xs uppercase">${utils.t('app_settings')}</div>
                            
                            <div class="p-4 flex justify-between items-center border-b border-slate-100">
                                <span class="text-slate-700">${utils.t('units')}</span>
                                <div class="flex bg-slate-100 rounded-lg p-1">
                                    <button onclick="store.data.settings.units='metric';store.save();ui.render()" class="${settings.units==='metric'?'bg-white shadow-sm text-sky-600':'text-slate-400'} px-3 py-1 rounded text-xs font-bold transition">Metric</button>
                                    <button onclick="store.data.settings.units='imperial';store.save();ui.render()" class="${settings.units==='imperial'?'bg-white shadow-sm text-sky-600':'text-slate-400'} px-3 py-1 rounded text-xs font-bold transition">Imperial</button>
                                </div>
                            </div>

                             <div class="p-4 flex justify-between items-center border-b border-slate-100">
                                <span class="text-slate-700">${utils.t('language')}</span>
                                <select onchange="store.data.settings.language=this.value;store.save();ui.render()" class="bg-slate-100 rounded-lg px-3 py-1 text-sm font-bold text-slate-600 outline-none">
                                    <option value="en" ${settings.language==='en'?'selected':''}>English</option>
                                    <option value="zh" ${settings.language==='zh'?'selected':''}>繁體中文</option>
                                </select>
                            </div>

                            <div class="p-4 flex justify-between items-center">
                                <span class="text-slate-700">${utils.t('currency')}</span>
                                <select onchange="store.data.settings.currency=this.value;store.save();ui.render()" class="bg-slate-100 rounded-lg px-3 py-1 text-sm font-bold text-slate-600 outline-none">
                                    <option value="$" ${settings.currency==='$'?'selected':''}>$ (USD)</option>
                                    <option value="€" ${settings.currency==='€'?'selected':''}>€ (EUR)</option>
                                    <option value="£" ${settings.currency==='£'?'selected':''}>£ (GBP)</option>
                                    <option value="¥" ${settings.currency==='¥'?'selected':''}>¥ (JPY)</option>
                                    <option value="HK$" ${settings.currency==='HK$'?'selected':''}>HK$ (HKD)</option>
                                    <option value="A$" ${settings.currency==='A$'?'selected':''}>A$ (AUD)</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl card-shadow overflow-hidden p-4 space-y-3">
                            <button onclick="ui.exportData()" class="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                <span class="material-icons">download</span> ${utils.t('export_json')}
                            </button>
                            <label class="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 cursor-pointer">
                                <span class="material-icons">upload</span> ${utils.t('import_json')}
                                <input type="file" accept=".json" onchange="ui.importData(this)" class="hidden">
                            </label>
                        </div>

                    </div>
                `;
            },

            /* --- MODALS --- */
            
            openModal(content) {
                const overlay = document.getElementById('modal-overlay');
                const box = document.getElementById('modal-content');
                box.innerHTML = content;
                overlay.classList.remove('hidden');
                // Trigger reflow
                void overlay.offsetWidth; 
                overlay.classList.remove('opacity-0');
                
                // Click outside to close logic
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        this.closeModal();
                    }
                };
            },

            closeModal() {
                const overlay = document.getElementById('modal-overlay');
                overlay.classList.add('opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    document.getElementById('modal-content').innerHTML = '';
                }, 300);
            },

            // Vehicle Form
            openAddVehicle(id = null) {
                const vehicle = id ? store.data.vehicles.find(v => v.id === id) : null;
                const isEdit = !!vehicle;
                
                this.openModal(`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">${isEdit ? utils.t('edit_vehicle') : utils.t('add_vehicle')}</h3>
                        <form onsubmit="event.preventDefault(); ui.submitVehicle('${id || ''}')" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Year</label>
                                <input type="number" id="v-year" value="${vehicle?.year || new Date().getFullYear()}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500 font-bold" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Make</label>
                                <input type="text" id="v-make" value="${vehicle?.make || ''}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500 font-bold" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Model</label>
                                <input type="text" id="v-model" value="${vehicle?.model || ''}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500 font-bold" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('odometer')}</label>
                                <input type="number" id="v-odo" value="${vehicle?.currentOdometer || 0}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-sky-500 font-bold" required>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mt-6">
                                ${isEdit ? `
                                    <button type="button" onclick="ui.deleteVehicle('${id}')" class="bg-red-50 text-red-500 font-bold py-3 rounded-xl">${utils.t('delete')}</button>
                                ` : `<button type="button" onclick="ui.closeModal()" class="bg-slate-100 text-slate-500 font-bold py-3 rounded-xl">${utils.t('cancel')}</button>`}
                                <button type="submit" class="bg-sky-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-sky-200">${utils.t('save')}</button>
                            </div>
                            
                            ${isEdit ? `
                                <div class="mt-6 pt-6 border-t border-slate-100">
                                    <button type="button" onclick="ui.clearVehicleData('${id}')" class="w-full bg-red-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-red-600 transition">
                                        ${utils.t('clear_history')}
                                    </button>
                                </div>
                            ` : ''}
                        </form>
                    </div>
                `);
            },

            submitVehicle(id) {
                const year = document.getElementById('v-year').value;
                const make = document.getElementById('v-make').value;
                const model = document.getElementById('v-model').value;
                const odo = document.getElementById('v-odo').value;

                const vehicle = {
                    id: id || utils.uuid(),
                    year, make, model, currentOdometer: parseInt(odo)
                };

                if (id) store.updateVehicle(vehicle);
                else store.addVehicle(vehicle);
                
                this.closeModal();
                this.render();
            },
            
            deleteVehicle(id) {
                setTimeout(() => {
                    if(window.confirm(utils.t('confirm_delete'))) {
                        store.deleteVehicle(id);
                        this.closeModal();
                        this.render();
                    }
                }, 50);
            },

            clearVehicleData(id) {
                setTimeout(() => {
                    if(window.confirm(utils.t('confirm_clear_1'))) {
                        setTimeout(() => {
                            if(window.confirm(utils.t('confirm_clear_2'))) {
                                store.clearVehicleLogs(id);
                                this.closeModal();
                                this.render();
                            }
                        }, 200);
                    }
                }, 50);
            },
            
            // Vehicle Selector Modal
            openVehicleSelector() {
                const vehicles = store.data.vehicles;
                if(vehicles.length === 0) return;
                
                const list = vehicles.map(v => `
                    <button onclick="store.data.settings.activeVehicleId='${v.id}';store.save();ui.closeModal();ui.render()" 
                        class="w-full p-4 flex items-center gap-4 border-b border-slate-100 last:border-0 hover:bg-slate-50 transition text-left">
                        <div class="w-10 h-10 rounded-full bg-sky-100 text-sky-600 flex items-center justify-center font-bold">
                            ${v.make[0]}
                        </div>
                        <div>
                            <div class="font-bold text-slate-800">${v.model}</div>
                            <div class="text-xs text-slate-400">${v.year} ${v.make}</div>
                        </div>
                        ${v.id === store.data.settings.activeVehicleId ? '<span class="material-icons text-green-500 ml-auto">check_circle</span>' : ''}
                    </button>
                `).join('');

                this.openModal(`
                    <div class="p-2">
                        <h3 class="p-4 text-lg font-bold text-slate-700 border-b border-slate-100">${utils.t('select_vehicle')}</h3>
                        <div class="max-h-[60vh] overflow-y-auto">
                            ${list}
                        </div>
                        <div class="p-2">
                            <button onclick="ui.closeModal();ui.openAddVehicle()" class="w-full py-3 text-sky-600 font-bold">+ ${utils.t('add_vehicle')}</button>
                        </div>
                    </div>
                `);
            },

            // Fuel Form
            openAddFuel(id = null) {
                const log = id ? store.data.logs.find(l => l.id === id) : null;
                const isEdit = !!log;
                
                this.openModal(`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">${isEdit ? utils.t('edit') : utils.t('add_fuel')}</h3>
                        <form onsubmit="event.preventDefault(); ui.submitFuel('${id||''}')" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('date')}</label>
                                <input type="date" id="f-date" value="${log?.date || new Date().toISOString().split('T')[0]}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('odometer')}</label>
                                <input type="number" id="f-odo" value="${log?.odometer || ''}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold" required>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('liters')}</label>
                                    <input type="number" step="0.01" id="f-liters" value="${log?.liters || ''}" oninput="ui.calcFuel('vol')" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('price_unit')}</label>
                                    <input type="number" step="0.001" id="f-price" value="${log?.pricePerUnit || ''}" oninput="ui.calcFuel('price')" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('cost')}</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-400 font-bold">${store.data.settings.currency}</span>
                                    <input type="number" step="0.01" id="f-cost" value="${log?.cost || ''}" oninput="ui.calcFuel('cost')" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 pl-8 outline-none font-bold" required>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('location')}</label>
                                <div class="flex gap-2">
                                    <input type="text" id="f-loc" value="${log?.location || ''}" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold">
                                    <button type="button" onclick="ui.detectLocation('f-loc')" class="bg-sky-100 text-sky-600 p-3 rounded-xl">
                                        <span class="material-icons">my_location</span>
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mt-6">
                                ${isEdit ? `
                                    <button type="button" onclick="ui.deleteLog('${id}')" class="bg-red-50 text-red-500 font-bold py-3 rounded-xl">${utils.t('delete')}</button>
                                ` : `<button type="button" onclick="ui.closeModal()" class="bg-slate-100 text-slate-500 font-bold py-3 rounded-xl">${utils.t('cancel')}</button>`}
                                <button type="submit" class="bg-teal-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-teal-200">${utils.t('save')}</button>
                            </div>
                        </form>
                    </div>
                `);
            },

            calcFuel(trigger) {
                const volEl = document.getElementById('f-liters');
                const priceEl = document.getElementById('f-price');
                const costEl = document.getElementById('f-cost');
                
                const vol = parseFloat(volEl.value) || 0;
                const price = parseFloat(priceEl.value) || 0;
                const cost = parseFloat(costEl.value) || 0;

                if (trigger === 'vol' && price > 0) {
                    costEl.value = (vol * price).toFixed(2);
                } else if (trigger === 'price' && vol > 0) {
                    costEl.value = (vol * price).toFixed(2);
                } else if (trigger === 'cost' && vol > 0) {
                    priceEl.value = (cost / vol).toFixed(3);
                }
            },

            submitFuel(id) {
                const log = {
                    id: id || utils.uuid(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: 'fuel',
                    date: document.getElementById('f-date').value,
                    odometer: parseFloat(document.getElementById('f-odo').value),
                    liters: parseFloat(document.getElementById('f-liters').value),
                    pricePerUnit: parseFloat(document.getElementById('f-price').value),
                    cost: parseFloat(document.getElementById('f-cost').value),
                    location: document.getElementById('f-loc').value
                };
                
                if(id) store.updateLog(log);
                else store.addLog(log);
                
                this.closeModal();
                this.render();
            },

            // Service/Maintenance/Parking Form
            openAddService(id = null, defaultType = 'maintenance') {
                const log = id ? store.data.logs.find(l => l.id === id) : null;
                const isEdit = !!log;
                const currentType = log?.type || defaultType;
                
                const typeOptions = [
                    {val: 'maintenance', lbl: utils.t('maintenance')},
                    {val: 'parking', lbl: utils.t('t_parking')},
                    {val: 'license', lbl: utils.t('license_renewal')},
                    {val: 'insurance', lbl: utils.t('insurance_renewal')},
                    {val: 'registration', lbl: utils.t('registration')},
                ];

                this.openModal(`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">${isEdit ? utils.t('edit') : utils.t('add_service')}</h3>
                        <form onsubmit="event.preventDefault(); ui.submitService('${id||''}')" class="space-y-4">
                             <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('type')}</label>
                                <select id="s-type" onchange="ui.toggleExpiryField()" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold">
                                    ${typeOptions.map(o => `<option value="${o.val}" ${currentType === o.val ? 'selected' : ''}>${o.lbl}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('date')}</label>
                                <input type="date" id="s-date" value="${log?.date || new Date().toISOString().split('T')[0]}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold" required>
                            </div>
                             
                            <!-- Conditional Expiry Field -->
                            <div id="expiry-field" class="${['license','insurance','registration'].includes(currentType) ? '' : 'hidden'}">
                                <label class="text-xs font-bold text-orange-500 uppercase block mb-1">${utils.t('new_expiry')}</label>
                                <input type="date" id="s-expiry" value="${log?.expiryDate || ''}" class="w-full bg-orange-50 border border-orange-200 rounded-xl p-3 outline-none font-bold text-orange-700">
                            </div>

                            <div id="odo-field">
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('odometer')}</label>
                                <input type="number" id="s-odo" value="${log?.odometer || ''}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('cost')}</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-400 font-bold">${store.data.settings.currency}</span>
                                    <input type="number" step="0.01" id="s-cost" value="${log?.cost || ''}" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 pl-8 outline-none font-bold" required>
                                </div>
                            </div>
                            
                            <div id="extra-fields" class="${['license','insurance','registration'].includes(currentType) ? 'hidden' : ''}">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('location')}</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="s-loc" value="${log?.location || ''}" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold">
                                        <button type="button" onclick="ui.detectLocation('s-loc')" class="bg-sky-100 text-sky-600 p-3 rounded-xl">
                                            <span class="material-icons">my_location</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="text-xs font-bold text-slate-400 uppercase block mb-1">${utils.t('notes')}</label>
                                    <textarea id="s-notes" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none font-bold">${log?.notes || ''}</textarea>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mt-6">
                                ${isEdit ? `
                                    <button type="button" onclick="ui.deleteLog('${id}')" class="bg-red-50 text-red-500 font-bold py-3 rounded-xl">${utils.t('delete')}</button>
                                ` : `<button type="button" onclick="ui.closeModal()" class="bg-slate-100 text-slate-500 font-bold py-3 rounded-xl">${utils.t('cancel')}</button>`}
                                <button type="submit" class="bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200">${utils.t('save')}</button>
                            </div>
                        </form>
                    </div>
                `);
            },

            toggleExpiryField() {
                const type = document.getElementById('s-type').value;
                const isDoc = ['license', 'insurance', 'registration'].includes(type);
                const expiryDiv = document.getElementById('expiry-field');
                const extraDiv = document.getElementById('extra-fields');
                
                if (isDoc) {
                    expiryDiv.classList.remove('hidden');
                    extraDiv.classList.add('hidden');
                } else {
                    expiryDiv.classList.add('hidden');
                    extraDiv.classList.remove('hidden');
                }
            },

            submitService(id) {
                const type = document.getElementById('s-type').value;
                const isDoc = ['license', 'insurance', 'registration'].includes(type);

                const log = {
                    id: id || utils.uuid(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: type,
                    date: document.getElementById('s-date').value,
                    odometer: parseFloat(document.getElementById('s-odo').value) || 0,
                    cost: parseFloat(document.getElementById('s-cost').value),
                    // Conditional fields
                    expiryDate: isDoc ? document.getElementById('s-expiry').value : null,
                    location: isDoc ? '' : document.getElementById('s-loc').value,
                    notes: isDoc ? '' : document.getElementById('s-notes').value
                };

                if(id) store.updateLog(log);
                else store.addLog(log);
                
                this.closeModal();
                this.render();
            },

            deleteLog(id) {
                setTimeout(() => {
                    if(window.confirm(utils.t('confirm_delete'))) {
                        store.deleteLog(id);
                        this.closeModal();
                        this.render();
                    }
                }, 50);
            },

            // Geocoding
            detectLocation(inputId) {
                if (!navigator.geolocation) {
                    alert("Geolocation is not supported by your browser");
                    return;
                }
                
                const btn = document.querySelector(`button[onclick="ui.detectLocation('${inputId}')"]`);
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<span class="material-icons animate-spin">refresh</span>';

                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        // Reverse Geocoding using OpenStreetMap Nominatim (Free)
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        // Try to get a meaningful name (poi -> road -> suburb)
                        const addr = data.address;
                        let name = data.name || '';
                        
                        if (!name) {
                             if (addr.amenity) name = addr.amenity;
                             else if (addr.building) name = addr.building;
                             else if (addr.road) name = addr.road;
                        }
                        
                        document.getElementById(inputId).value = name || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                    } catch (e) {
                        document.getElementById(inputId).value = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                    }
                    btn.innerHTML = originalIcon;
                }, () => {
                    alert("Unable to retrieve your location");
                    btn.innerHTML = originalIcon;
                });
            },

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(store.data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "fuelmate_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            importData(input) {
                const file = input.files[0];
                if (!file) return;
                
                // Security: Confirm overwrite
                setTimeout(() => {
                    if(!confirm(utils.t('confirm_overwrite'))) {
                        input.value = ''; // Reset input
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            if (json.vehicles && json.logs) {
                                store.data = json;
                                store.save();
                                alert(utils.t('import_success'));
                                ui.render();
                            } else {
                                alert(utils.t('import_error'));
                            }
                        } catch (ex) {
                            alert(utils.t('import_error'));
                        } finally {
                            input.value = ''; // Reset input to allow re-selecting same file
                        }
                    };
                    reader.readAsText(file);
                }, 50);
            }
        };

        /* --- ROUTER --- */
        const router = {
            navigate(page) {
                ui.currentPage = page;
                ui.render();
            }
        };

        /* --- INIT --- */
        store.init();
        ui.render();

    </script>
</body>
</html>