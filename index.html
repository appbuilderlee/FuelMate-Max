<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FuelMate</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* Light Mode Variables */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --app-blue: #00b4db;
            --app-teal: #0083b0;
            
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --bg-header: rgba(243, 244, 246, 0.95);
            --bg-nav: rgba(255, 255, 255, 0.9);
            --bg-input: #f8fafc;
            --border-color: #e2e8f0;
            
            --text-main: #334155;
            --text-sub: #94a3b8;
            --text-heading: #1e293b;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Dark Mode Variables */
                --bg-main: #0f172a;
                --bg-card: #1e293b;
                --bg-header: rgba(15, 23, 42, 0.95);
                --bg-nav: rgba(30, 41, 59, 0.9);
                --bg-input: #334155;
                --border-color: #334155;
                
                --text-main: #e2e8f0;
                --text-sub: #94a3b8;
                --text-heading: #f8fafc;
            }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            /* Native scrolling */
            overflow-y: auto; 
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dynamic Classes based on CSS Vars */
        .theme-bg-card { background-color: var(--bg-card); }
        .theme-text-main { color: var(--text-main); }
        .theme-text-sub { color: var(--text-sub); }
        .theme-text-heading { color: var(--text-heading); }
        .theme-border { border-color: var(--border-color); }

        /* Safe Area Spacing */
        .pt-safe { padding-top: calc(var(--safe-top) + 22px); }
        .pb-safe { padding-bottom: calc(var(--safe-bottom) + 80px); }
        
        /* Sticky Headers */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 40;
            padding-top: var(--safe-top);
            background: var(--bg-header);
            backdrop-filter: blur(10px);
            transition: background-color 0.3s;
        }

        /* Custom Input Styling for Dark Mode compatibility */
        .input-field {
            background-color: var(--bg-input);
            color: var(--text-heading);
            border: 1px solid var(--border-color);
        }
        .input-field:focus {
            border-color: var(--app-blue);
        }

        /* Card Styles */
        .card-shadow { 
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        /* Floating Action Button */
        .fab-shadow { box-shadow: 0 4px 15px rgba(0, 180, 219, 0.4); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
    <script>
        // Dynamic Icon Generator (Standard Material Vector Path)
        (function() {
            const size = 1024;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // 1. Background Gradient (FuelMate Blue/Teal)
            const grd = ctx.createLinearGradient(0, 0, size, size);
            grd.addColorStop(0, '#0ea5e9'); // Sky 500
            grd.addColorStop(1, '#0284c7'); // Sky 600
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, size, size);

            // 2. Draw Standard Gas Pump Icon using SVG Path
            // This ensures geometric perfection and matches the user's reference image.
            const pathData = "M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33a2.5 2.5 0 0 0 2.5 2.5c.36 0 .69-.08 1-.21v7.21c0 .55-.45 1-1 1s-1-.45-1-1V14c0-1.1-.9-2-2-2h-1V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v16h10v-7.5h1.5v5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V9c0-.69-.28-1.32-.73-1.77zM12 10H6V5h6v5zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z";
            
            const p = new Path2D(pathData);
            ctx.fillStyle = "white";
            
            // Center and Scale Logic
            // Standard icon is 24x24. We want to scale it to fill about 65% of the 1024px canvas.
            ctx.translate(size / 2, size / 2);
            const scale = size / 36; 
            ctx.scale(scale, scale);
            ctx.translate(-12, -12); // Offset to center the 24x24 path
            
            ctx.fill(p);

            // 3. Generate Links
            const dataUrl = canvas.toDataURL('image/png');
            const link = document.createElement('link');
            link.rel = 'apple-touch-icon';
            link.href = dataUrl;
            document.head.appendChild(link);

            const manifest = {
                name: "FuelMate",
                short_name: "FuelMate",
                start_url: ".",
                display: "standalone",
                background_color: "#f3f4f6",
                theme_color: "#0284c7",
                icons: [{ src: dataUrl, sizes: "512x512", type: "image/png" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestUrl = URL.createObjectURL(blob);
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = manifestUrl;
            document.head.appendChild(manifestLink);
        })();
    </script>
</head>
<body>

    <div id="app" class="min-h-screen pb-safe">
        <!-- Dynamic Content -->
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 w-full border-t theme-border flex justify-around items-center pb-[env(safe-area-inset-bottom)] pt-2 z-50 transition-colors duration-300" style="background-color: var(--bg-nav); padding-bottom: max(10px, env(safe-area-inset-bottom)); backdrop-filter: blur(20px);">
        <button onclick="router.navigate('dashboard')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="dashboard">
            <span class="material-icons text-2xl mb-0.5">dashboard</span>
            <span class="text-[10px] font-medium t-dash">Dash</span>
        </button>
        <button onclick="router.navigate('fuel')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="fuel">
            <span class="material-icons text-2xl mb-0.5">local_gas_station</span>
            <span class="text-[10px] font-medium t-fuel">Fuel</span>
        </button>
         <button onclick="router.navigate('parking')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="parking">
            <span class="material-icons text-2xl mb-0.5">local_parking</span>
            <span class="text-[10px] font-medium t-parking">Park</span>
        </button>
        <button onclick="router.navigate('maintenance')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="maintenance">
            <span class="material-icons text-2xl mb-0.5">build</span>
            <span class="text-[10px] font-medium t-service">Service+</span>
        </button>
        <button onclick="router.navigate('analytics')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="analytics">
            <span class="material-icons text-2xl mb-0.5">pie_chart</span>
            <span class="text-[10px] font-medium t-analytics">Analytics</span>
        </button>
        <button onclick="router.navigate('settings')" class="nav-btn p-2 flex flex-col items-center text-slate-400 transition duration-300" data-page="settings">
            <span class="material-icons text-2xl mb-0.5">settings</span>
            <span class="text-[10px] font-medium t-settings">Settings</span>
        </button>
    </nav>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div id="modal-content" class="card-shadow rounded-3xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300 overflow-hidden max-h-[90vh] overflow-y-auto">
            <!-- Modal Content Injected Here -->
        </div>
    </div>

    <script>
        /* --- TRANSLATIONS --- */
        const translations = {
            en: {
                t_dash: "Dash", t_fuel: "Fuel", t_service: "Service+", t_parking: "Park", t_analytics: "Analytics", t_settings: "Settings",
                welcome: "Welcome to FuelMate", no_vehicle: "No vehicle added", add_first: "Add your first vehicle to get started",
                add_vehicle: "Add Vehicle", edit_vehicle: "Edit Vehicle", select_vehicle: "Select Vehicle",
                mode_month: "By Month", mode_year: "By Year", mode_all: "All Time",
                efficiency: "EFFICIENCY", cost_km: "COST/KM", total_cost: "TOTAL COST", total_distance: "TOTAL DISTANCE",
                reminders: "Reminders", expiring_soon: "Expiring Soon", expired: "Expired", days_left: "days left",
                add_fuel: "Add Fuel", add_service: "Add Service", add_parking: "Add Parking",
                recent_activity: "RECENT ACTIVITY", no_records: "No records yet",
                date: "DATE", odometer: "ODOMETER", liters: "LITERS", gallons: "GALLONS", kwh: "kWh", cost: "COST", price_unit: "PRICE/UNIT",
                fuel_type: "FUEL TYPE", location: "LOCATION", notes: "NOTES", type: "TYPE",
                save: "Save", cancel: "Cancel", delete: "Delete", edit: "Edit", clear_history: "Clear History",
                confirm_delete: "Are you sure you want to delete this record?",
                confirm_clear_1: "WARNING: This will delete ALL Fuel, Service, and Parking logs for this vehicle.",
                confirm_clear_2: "Are you absolutely sure? This cannot be undone.",
                settings_title: "Settings", manage_vehicles: "Manage Vehicles", app_settings: "App Settings",
                units: "Units", currency: "Currency", language: "Language", fuel_unit: "Fuel Unit",
                export_json: "Export Data (JSON)", import_json: "Import Data (JSON)", export_csv: "Export to Excel (CSV)",
                import_success: "Data imported successfully!", import_error: "Invalid JSON file.",
                confirm_overwrite: "WARNING: This will overwrite all current data. Are you sure?",
                license_renewal: "License Renewal", insurance_renewal: "Insurance Renewal", registration: "Vehicle Registration",
                new_expiry: "NEW EXPIRY DATE", detect_loc: "Detect",
                parking_cost: "PARKING COST", service_cost: "SERVICE COST", fixed_costs: "FIXED COSTS",
                maintenance: "Maintenance",
                notif_settings: "Notifications", reminder_timing: "Remind me", 
                day_0: "On the day", day_7: "1 Week before", day_30: "1 Month before",
                export_cal_title: "Add to Calendar", export_cal_desc: "Select an item to add to your iPhone calendar",
                no_expiry_found: "No expiry date found for this item. Please add a record first.",
                reminder_option_title: "Set Reminder Alert", reminder_none: "No Alert", 
                reminder_on_day: "On Day of Expiry (9:00 AM)", reminder_1_week: "1 Week Before (9:00 AM)", reminder_1_month: "1 Month Before (9:00 AM)",
                edit_parking: "Edit Parking",
                common_services: "Common Services",
                s_oil: "Oil Change", s_filter: "Oil Filter", s_tires: "Tire Rotation", s_battery: "Battery",
                s_brakes: "Brake Pads", s_wipers: "Wipers", s_fluids: "Fluids", s_inspect: "Inspection",
                s_wash: "Car Wash", s_aircon: "A/C Filter",
                car_wash: "Car Wash", car_accessories: "Accessories",
                periodic_maintenance: "Periodic Maintenance",
                service_settings: "Maintenance Schedule", service_interval: "Interval",
                km_5000: "Every 5,000 km", km_10000: "Every 10,000 km",
                m_6: "Every 6 Months", m_12: "Every 1 Year", off: "Off",
                service_due: "Service Due!", service_soon: "Service Soon", due_in: "Due in",
                partial_tank: "Partial Tank / Missed Log", partial_desc: "Check if you didn't fill up completely or missed the previous log. This skips efficiency calculation for this entry.",
                search: "Search", trend_chart: "Efficiency Trend",
                t_fine: "Traffic Fine",
                f_parking: "Parking Ticket", f_speeding: "Speeding", f_red_light: "Red Light",
                f_lane: "Lane Violation", f_phone: "Phone Use",
                backup_reminder: "Data Backup Reminder",
                backup_desc: "It's been over 30 days since your last backup. Protect your data!",
                backup_now: "Backup Now",
                remind_later: "Later",
                input_mode: "Input Mode", odo_total: "Total ODO", odo_trip: "Trip Distance",
                bar_chart: "Monthly Expenses", vehicle_color: "Color", vehicle_type: "Body Type",
                c_sedan: "Sedan/Hatch", c_suv: "SUV", c_truck: "Truck", c_bike: "Motorcycle",
                c_sports: "Sports Car", c_van: "Van/MPV", c_bus: "Bus",
                col_blue: "Blue", col_red: "Red", col_black: "Black", col_white: "White", col_silver: "Silver",
                col_green: "Green", col_yellow: "Yellow", col_orange: "Orange", col_purple: "Purple", col_brown: "Brown", col_grey: "Dark Grey",
                col_dark_red: "Dark Red", col_dark_green: "Dark Green", col_pink: "Pink", col_teal: "Teal", col_gold: "Gold",
                about_app: "About FuelMate", about_desc: "Version 1.0.0",
                about_intro: "FuelMate is your complete vehicle companion. Track fuel efficiency, log maintenance, manage expenses, and never miss a renewal deadline.",
                about_features: "Key Features",
                feat_1: "Track Fuel (L/gal/kWh) & Costs", feat_2: "Maintenance & Service Logs", feat_3: "Expense Analytics & Charts",
                feat_4: "Renewal Reminders (Calendar Sync)", feat_5: "Offline & Privacy Focused",
                about_tech: "Architecture",
                tech_desc: "Built as a Single-File PWA using Vanilla JavaScript. No servers, no tracking. All data is stored locally on your device."
            },
            zh: {
                t_dash: "首頁", t_fuel: "加油", t_service: "維修/其他", t_parking: "停車", t_analytics: "統計", t_settings: "設定",
                welcome: "歡迎使用 FuelMate", no_vehicle: "尚未添加車輛", add_first: "添加您的第一輛車以開始使用",
                add_vehicle: "新增車輛", edit_vehicle: "編輯車輛", select_vehicle: "選擇車輛",
                mode_month: "按月份", mode_year: "按年份", mode_all: "全部",
                efficiency: "能耗表現", cost_km: "每公里成本", total_cost: "總支出", total_distance: "總里程",
                reminders: "提醒通知", expiring_soon: "即將到期", expired: "已過期", days_left: "天後到期",
                add_fuel: "新增加油/電", add_service: "新增維修", add_parking: "新增停車",
                recent_activity: "近期活動", no_records: "等待更多記錄",
                date: "日期", odometer: "里程", liters: "公升", gallons: "加侖", kwh: "度 (kWh)", cost: "金額", price_unit: "單價",
                fuel_type: "能源種類", location: "地點", notes: "備註", type: "類型",
                save: "保存", cancel: "取消", delete: "刪除", edit: "編輯", clear_history: "清除所有紀錄",
                confirm_delete: "確定要刪除此記錄嗎？",
                confirm_clear_1: "警告：這將刪除此車輛的所有加油、維修和停車記錄。",
                confirm_clear_2: "您確定要繼續嗎？此操作無法撤銷。",
                settings_title: "設定", manage_vehicles: "車輛管理", app_settings: "應用設定",
                units: "單位", currency: "貨幣", language: "語言", fuel_unit: "能源單位",
                export_json: "匯出資料 (JSON)", import_json: "匯入資料 (JSON)", export_csv: "匯出 Excel (CSV)",
                import_success: "資料匯入成功！", import_error: "無效的 JSON 文件。",
                confirm_overwrite: "警告：這將覆蓋當前所有數據。您確定要繼續嗎？",
                license_renewal: "車牌續期", insurance_renewal: "保險續期", registration: "車輛登記",
                new_expiry: "新到期日", detect_loc: "定位",
                parking_cost: "停車總支出", service_cost: "維修總支出", fixed_costs: "固定支出 (牌照/保險)",
                maintenance: "維修保養",
                notif_settings: "提醒通知設定", reminder_timing: "提醒時間", 
                day_0: "當天提醒", day_7: "提早 1 週", day_30: "提早 1 個月",
                export_cal_title: "加入日曆", export_cal_desc: "選擇要加入 iPhone 日曆的項目",
                no_expiry_found: "找不到此項目的到期日，請先新增記錄。",
                reminder_option_title: "選擇提醒時間", reminder_none: "無提醒", 
                reminder_on_day: "當天提醒 (上午9:00)", reminder_1_week: "提早 1 週 (上午9:00)", reminder_1_month: "提早 1 個月 (上午9:00)",
                edit_parking: "編輯停車",
                common_services: "常見項目",
                s_oil: "換機油", s_filter: "機油濾芯", s_tires: "輪胎對調", s_battery: "更換電池",
                s_brakes: "更換煞車皮", s_wipers: "更換雨刷", s_fluids: "補充水箱水", s_inspect: "車輛檢查",
                s_wash: "洗車/美容", s_aircon: "冷氣濾網",
                car_wash: "洗車", car_accessories: "汽車用品",
                periodic_maintenance: "定期保養",
                service_settings: "定期保養排程", service_interval: "保養間隔",
                km_5000: "每 5,000 公里", km_10000: "每 10,000 公里",
                m_6: "每 6 個月", m_12: "每 1 年", off: "關閉",
                service_due: "保養到期！", service_soon: "即將保養", due_in: "剩餘",
                partial_tank: "未加滿 / 漏記", partial_desc: "如果您未加滿或漏記了上一筆記錄，請勾選此項。這將跳過本次的能耗計算。",
                search: "搜尋", trend_chart: "能耗趨勢",
                t_fine: "罰單/告票",
                f_parking: "違例泊車", f_speeding: "超速", f_red_light: "衝紅燈",
                f_lane: "切線違規", f_phone: "駕駛用電話",
                backup_reminder: "備份提醒",
                backup_desc: "您已超過 30 天沒有備份資料。請備份以防資料丟失！",
                backup_now: "立即備份",
                remind_later: "稍後",
                input_mode: "輸入模式", odo_total: "總里程", odo_trip: "行駛距離 (Trip)",
                bar_chart: "每月支出統計", vehicle_color: "車輛顏色", vehicle_type: "車型",
                c_sedan: "房車/轎車", c_suv: "休旅車/SUV", c_truck: "卡車", c_bike: "機車",
                c_sports: "跑車", c_van: "廂型車/MPV", c_bus: "巴士",
                col_blue: "藍色", col_red: "紅色", col_black: "黑色", col_white: "白色", col_silver: "銀色",
                col_green: "綠色", col_yellow: "黃色", col_orange: "橙色", col_purple: "紫色", col_brown: "棕色", col_grey: "深灰",
                col_dark_red: "深紅", col_dark_green: "深綠", col_pink: "粉紅", col_teal: "青色", col_gold: "金色",
                about_app: "關於 FuelMate", about_desc: "版本 1.0.0",
                about_intro: "FuelMate 是您的全方位車輛管家。追蹤油耗、記錄維修、管理支出，並確保不錯過任何續期截止日。",
                about_features: "核心功能",
                feat_1: "追蹤油耗 (L/gal/kWh) 與成本", feat_2: "維修保養與服務記錄", feat_3: "支出統計與趨勢分析",
                feat_4: "續期提醒 (支援日曆同步)", feat_5: "離線使用，隱私優先",
                about_tech: "技術架構",
                tech_desc: "採用單文件 PWA 技術構建，使用原生 JavaScript。無後端伺服器、無數據追蹤。所有資料均存儲在您的設備本地。"
            }
        };

        /* --- STORE --- */
        const store = {
            data: {
                vehicles: [],
                logs: [],
                settings: { 
                    activeVehicleId: null, 
                    units: 'metric', 
                    currency: '$', 
                    language: 'en',
                    lastBackupDate: null, 
                    reminders: {
                        license: { enabled: true, days: 30 },
                        insurance: { enabled: true, days: 30 },
                        registration: { enabled: true, days: 30 }
                    },
                    maintenance: { kmInterval: 0, timeInterval: 0 }
                }
            },
            // Filters
            pageFilters: {
                dashboard: { mode: 'month', value: new Date().toISOString().slice(0,7) },
                fuel: { mode: 'month', value: new Date().toISOString().slice(0,7) },
                maintenance: { mode: 'month', value: new Date().toISOString().slice(0,7) },
                maintenanceSearch: '', 
                parking: { mode: 'month', value: new Date().toISOString().slice(0,7) },
                analytics: { mode: 'year', value: new Date().getFullYear().toString() },
                hideBackupBanner: false 
            },
            init() {
                const saved = localStorage.getItem('fuelmate_data');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.data = { ...this.data, ...parsed };
                    if (!this.data.settings.reminders) {
                        this.data.settings.reminders = {
                            license: { enabled: true, days: 30 },
                            insurance: { enabled: true, days: 30 },
                            registration: { enabled: true, days: 30 }
                        };
                    }
                    if (!this.data.settings.maintenance) {
                        this.data.settings.maintenance = { kmInterval: 0, timeInterval: 0 };
                    }
                    if (this.data.settings.lastBackupDate === undefined) {
                        this.data.settings.lastBackupDate = Date.now(); 
                        this.save();
                    }
                }
                if (!this.data.settings.language) this.data.settings.language = 'en';
                
                const currentMonth = new Date().toISOString().slice(0,7);
                const currentYear = new Date().getFullYear().toString();
                this.pageFilters.fuel = { mode: 'month', value: currentMonth };
                this.pageFilters.maintenance = { mode: 'month', value: currentMonth };
                this.pageFilters.parking = { mode: 'month', value: currentMonth };
                this.pageFilters.analytics = { mode: 'year', value: currentYear };
                this.pageFilters.dashboard = { mode: 'month', value: currentMonth };
            },
            save() {
                localStorage.setItem('fuelmate_data', JSON.stringify(this.data));
                const scrollY = window.scrollY;
                ui.render();
                window.scrollTo(0, scrollY);
            },
            addVehicle(vehicle) {
                this.data.vehicles.push(vehicle);
                if (!this.data.settings.activeVehicleId) this.data.settings.activeVehicleId = vehicle.id;
                this.save();
            },
            updateVehicle(vehicle) {
                const idx = this.data.vehicles.findIndex(v => v.id === vehicle.id);
                if (idx !== -1) {
                    this.data.vehicles[idx] = vehicle;
                    this.save();
                }
            },
            deleteVehicle(id) {
                this.data.vehicles = this.data.vehicles.filter(v => v.id !== id);
                this.data.logs = this.data.logs.filter(l => l.vehicleId !== id);
                if (this.data.settings.activeVehicleId === id) {
                    this.data.settings.activeVehicleId = this.data.vehicles.length > 0 ? this.data.vehicles[0].id : null;
                }
                this.save();
            },
            clearVehicleLogs(vid) {
                this.data.logs = this.data.logs.filter(l => l.vehicleId !== vid);
                this.save();
            },
            addLog(log) {
                this.data.logs.push(log);
                const vehicle = this.getActiveVehicle();
                if (vehicle && log.odometer > vehicle.currentOdometer) {
                    vehicle.currentOdometer = parseInt(log.odometer);
                }
                this.save();
            },
            updateLog(log) {
                const idx = this.data.logs.findIndex(l => l.id === log.id);
                if (idx !== -1) {
                    this.data.logs[idx] = log;
                    const vehicle = this.getActiveVehicle();
                    const maxOdo = Math.max(...this.data.logs.filter(l => l.vehicleId === vehicle.id).map(l => parseInt(l.odometer) || 0));
                    vehicle.currentOdometer = maxOdo;
                    this.save();
                }
            },
            deleteLog(id) {
                this.data.logs = this.data.logs.filter(l => l.id !== id);
                this.save();
            },
            getActiveVehicle() {
                return this.data.vehicles.find(v => v.id === this.data.settings.activeVehicleId);
            },
            getVehicleLogs(type = null) {
                let logs = this.data.logs.filter(l => l.vehicleId === this.data.settings.activeVehicleId);
                if (type) {
                    if (type === 'maintenance') {
                        return logs.filter(l => ['maintenance', 'car_wash', 'car_accessories', 'license', 'insurance', 'registration', 'periodic_maintenance', 'fine'].includes(l.type));
                    }
                    return logs.filter(l => l.type === type);
                }
                return logs.sort((a, b) => new Date(b.date) - new Date(a.date));
            }
        };

        /* --- UTILS --- */
        const utils = {
            t(key) {
                const lang = store.data.settings.language || 'en';
                return translations[lang][key] || key;
            },
            uuid() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            formatCurrency(amount) {
                return `${store.data.settings.currency}${parseFloat(amount).toFixed(2)}`;
            },
            formatDate(dateStr) {
                const date = new Date(dateStr);
                const lang = store.data.settings.language;
                if (lang === 'zh') {
                    return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
                }
                return date.toLocaleDateString('en-GB');
            },
            getAvailableYears() {
                const logs = store.getVehicleLogs();
                const years = new Set();
                const currentYear = new Date().getFullYear();
                years.add(currentYear);
                logs.forEach(l => years.add(new Date(l.date).getFullYear()));
                return Array.from(years).sort((a,b) => b - a);
            },
            filterLogs(logs, filter) {
                if (!filter || filter.mode === 'all') return logs;
                return logs.filter(l => {
                    const d = new Date(l.date);
                    if (filter.mode === 'month') {
                        const [y, m] = filter.value.split('-');
                        return d.getFullYear() === parseInt(y) && (d.getMonth() + 1) === parseInt(m);
                    } else if (filter.mode === 'year') {
                        return d.getFullYear() === parseInt(filter.value);
                    }
                    return true;
                });
            },
            calculateStats(filter, category = 'all') {
                const logs = store.getVehicleLogs();
                const filtered = utils.filterLogs(logs, filter);

                let targetLogs = filtered;
                if (category === 'fuel') {
                    targetLogs = filtered.filter(l => l.type === 'fuel');
                } else if (category === 'maintenance') {
                    targetLogs = filtered.filter(l => ['maintenance', 'car_wash', 'car_accessories', 'license', 'insurance', 'registration', 'periodic_maintenance', 'fine'].includes(l.type));
                } else if (category === 'parking') {
                    targetLogs = filtered.filter(l => l.type === 'parking');
                }

                const totalCost = targetLogs.reduce((sum, l) => sum + parseFloat(l.cost || 0), 0);
                
                let totalDist = 0;
                if (targetLogs.length > 1) {
                    const sorted = [...targetLogs].sort((a, b) => a.odometer - b.odometer);
                    const min = sorted[0].odometer;
                    const max = sorted[sorted.length - 1].odometer;
                    totalDist = max - min;
                }

                let efficiency = 0;
                let costPerKm = 0;
                
                if (category === 'fuel' || category === 'all') {
                    const fuelLogs = targetLogs.filter(l => l.type === 'fuel').sort((a,b) => a.odometer - b.odometer);
                    if (fuelLogs.length > 1) {
                        let totalFuel = 0;
                        for(let i=0; i<fuelLogs.length; i++){
                             totalFuel += parseFloat(fuelLogs[i].liters);
                        }
                        const dist = fuelLogs[fuelLogs.length-1].odometer - fuelLogs[0].odometer;
                        if(dist > 0) {
                            efficiency = (totalFuel / dist) * 100;
                            costPerKm = totalCost / dist;
                        }
                    }
                }
                
                if (category !== 'fuel' && totalDist > 0) {
                     costPerKm = totalCost / totalDist;
                }

                return { totalCost, totalDist, efficiency, costPerKm };
            },
            generateTrendChart(logs) {
                const fuelLogs = logs.filter(l => l.type === 'fuel').sort((a,b) => a.odometer - b.odometer);
                const dataPoints = [];
                
                for (let i = 1; i < fuelLogs.length; i++) {
                    const curr = fuelLogs[i];
                    const prev = fuelLogs[i-1];
                    if (!curr.isPartial && !prev.isPartial) {
                        const dist = curr.odometer - prev.odometer;
                        if (dist > 0) {
                            const l100 = (curr.liters / dist) * 100;
                            if (l100 > 0 && l100 < 100) {
                                dataPoints.push(l100);
                            }
                        }
                    }
                }

                if (dataPoints.length < 2) return `<p class="text-center text-xs text-slate-400 py-8 italic">${utils.t('no_records')}</p>`;

                const width = 300;
                const height = 100;
                const padding = 10;
                
                const maxVal = Math.max(...dataPoints) * 1.1;
                const minVal = Math.min(...dataPoints) * 0.9;
                const range = maxVal - minVal;
                const xStep = (width - 2*padding) / (dataPoints.length - 1);

                let pathD = `M ${padding} ${height - padding - ((dataPoints[0] - minVal) / range) * (height - 2*padding)}`;
                let polyPoints = `${padding},${height} `;

                dataPoints.forEach((val, i) => {
                    const x = padding + i * xStep;
                    const y = height - padding - ((val - minVal) / range) * (height - 2*padding);
                    if (i > 0) pathD += ` L ${x} ${y}`;
                    polyPoints += `${x},${y} `;
                });

                polyPoints += `${width-padding},${height} ${padding},${height}`;

                return `
                    <svg viewBox="0 0 ${width} ${height}" class="w-full h-full overflow-visible">
                        <defs>
                            <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="rgb(14, 165, 233)" stop-opacity="0.3"/>
                                <stop offset="100%" stop-color="rgb(14, 165, 233)" stop-opacity="0"/>
                            </linearGradient>
                        </defs>
                        <polyline points="${polyPoints}" fill="url(#chartGradient)" />
                        <path d="${pathD}" fill="none" stroke="rgb(14, 165, 233)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        ${dataPoints.map((val, i) => {
                            const x = padding + i * xStep;
                            const y = height - padding - ((val - minVal) / range) * (height - 2*padding);
                            return `<circle cx="${x}" cy="${y}" r="3" fill="white" stroke="rgb(14, 165, 233)" stroke-width="2"/>`;
                        }).join('')}
                    </svg>
                `;
            },
            generateBarChart(logs) {
                 const monthlyData = {};
                 // Get last 6 months including current
                 for(let i=5; i>=0; i--) {
                     const d = new Date();
                     d.setMonth(d.getMonth() - i);
                     const key = d.toISOString().slice(0,7); // YYYY-MM
                     monthlyData[key] = { fuel: 0, service: 0, month: d.getMonth()+1 };
                 }

                 logs.forEach(l => {
                     const key = l.date.slice(0,7);
                     if (monthlyData[key]) {
                         const cost = parseFloat(l.cost || 0);
                         if (l.type === 'fuel') monthlyData[key].fuel += cost;
                         else if (l.type === 'parking') monthlyData[key].service += cost; // Parking as service color for simple stacking
                         else monthlyData[key].service += cost;
                     }
                 });

                 const keys = Object.keys(monthlyData).sort();
                 let maxVal = 0;
                 keys.forEach(k => {
                     const total = monthlyData[k].fuel + monthlyData[k].service;
                     if(total > maxVal) maxVal = total;
                 });
                 
                 if(maxVal === 0) return `<p class="text-center text-xs text-slate-400 py-8 italic">${utils.t('no_records')}</p>`;
                 maxVal = maxVal * 1.1;

                 const width = 300;
                 const height = 120;
                 const padding = 20;
                 const barWidth = 20;
                 const step = (width - 2*padding) / keys.length;

                 return `
                    <svg viewBox="0 0 ${width} ${height}" class="w-full h-full overflow-visible">
                        ${keys.map((k, i) => {
                            const d = monthlyData[k];
                            const x = padding + i * step + (step - barWidth)/2;
                            const hFuel = (d.fuel / maxVal) * (height - 2*padding);
                            const hService = (d.service / maxVal) * (height - 2*padding);
                            const yFuel = height - padding - hFuel;
                            const yService = yFuel - hService;
                            
                            return `
                                <rect x="${x}" y="${yFuel}" width="${barWidth}" height="${hFuel}" fill="#14b8a6" rx="2" />
                                <rect x="${x}" y="${yService}" width="${barWidth}" height="${hService}" fill="#6366f1" rx="2" />
                                <text x="${x + barWidth/2}" y="${height}" text-anchor="middle" font-size="10" fill="#94a3b8">${d.month}</text>
                            `;
                        }).join('')}
                    </svg>
                    <div class="flex justify-center gap-4 mt-2">
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-teal-500"></div><span class="text-[10px] text-slate-400">Fuel</span></div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-indigo-500"></div><span class="text-[10px] text-slate-400">Service/Park</span></div>
                    </div>
                 `;
            },
            getFuelUnit() {
                const v = store.getActiveVehicle();
                return v && v.fuelUnit ? v.fuelUnit : 'L';
            },
            getDistUnit() {
                return store.data.settings.units === 'imperial' ? 'mi' : 'km';
            },
            getEfficiencyLabel() {
                const unit = utils.getFuelUnit();
                if (unit === 'kWh') return 'kWh/100km';
                if (store.data.settings.units === 'imperial') return 'MPG';
                return 'L/100km';
            },
            getCarIcon(vehicle) {
                const type = vehicle.type || 'sedan';
                const iconMap = { 
                    sedan: 'directions_car', suv: 'airport_shuttle', truck: 'local_shipping', bike: 'two_wheeler',
                    sports: 'sports_car', van: 'airport_shuttle', bus: 'directions_bus'
                };
                return iconMap[type] || 'directions_car';
            },
            getCarColorClass(vehicle) {
                const color = vehicle.color || 'blue';
                const map = {
                    blue: 'bg-sky-500', red: 'bg-red-500', black: 'bg-slate-800', white: 'bg-slate-200 text-slate-600',
                    green: 'bg-emerald-500', silver: 'bg-gray-400',
                    yellow: 'bg-yellow-400 text-yellow-900', orange: 'bg-orange-500', 
                    purple: 'bg-purple-500', brown: 'bg-amber-800', grey: 'bg-slate-600',
                    dark_red: 'bg-red-900', dark_green: 'bg-emerald-900', cyan: 'bg-cyan-500',
                    pink: 'bg-pink-500', teal: 'bg-teal-600', gold: 'bg-yellow-600 text-yellow-900'
                };
                return map[color] || 'bg-sky-500';
            },
            getVehicleGradient(color) {
                const map = {
                    blue: 'from-cyan-500 to-blue-600', red: 'from-rose-500 to-red-600', black: 'from-slate-700 to-slate-900',
                    white: 'from-slate-300 to-slate-400', green: 'from-emerald-500 to-teal-600', silver: 'from-gray-400 to-slate-500',
                    yellow: 'from-yellow-400 to-orange-500', orange: 'from-orange-500 to-red-500',
                    purple: 'from-purple-500 to-indigo-600', brown: 'from-amber-700 to-orange-900', grey: 'from-gray-500 to-slate-600',
                    dark_red: 'from-red-800 to-red-950', dark_green: 'from-emerald-800 to-emerald-950', cyan: 'from-cyan-400 to-cyan-600',
                    pink: 'from-pink-500 to-rose-500', teal: 'from-teal-500 to-teal-700', gold: 'from-yellow-500 to-yellow-700'
                };
                return map[color] || 'from-cyan-500 to-blue-600';
            }
        };

        /* --- UI RENDERER --- */
        const ui = {
            currentPage: 'dashboard',
            
            render() {
                const app = document.getElementById('app');
                const vehicle = store.getActiveVehicle();
                const scrollY = window.scrollY; 
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const active = btn.dataset.page === this.currentPage;
                    btn.className = `nav-btn p-2 flex flex-col items-center transition duration-300 ${active ? 'text-sky-500' : 'text-slate-400'}`;
                });

                if (!vehicle && this.currentPage !== 'settings') {
                    app.innerHTML = this.renderNoVehicleState();
                    return;
                }

                if (this.currentPage === 'dashboard') this.renderDashboard(app, vehicle);
                else if (this.currentPage === 'fuel') this.renderFuel(app, vehicle);
                else if (this.currentPage === 'maintenance') this.renderMaintenance(app, vehicle);
                else if (this.currentPage === 'parking') this.renderParking(app, vehicle);
                else if (this.currentPage === 'analytics') this.renderAnalytics(app, vehicle);
                else if (this.currentPage === 'settings') this.renderSettings(app);
                
                if (scrollY > 0) window.scrollTo(0, scrollY);
            },

            renderNoVehicleState() {
                return `
                    <div class="h-screen flex flex-col items-center justify-center p-8 text-center theme-text-main">
                        <div class="w-24 h-24 bg-sky-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                            <span class="material-icons text-5xl text-sky-600">directions_car</span>
                        </div>
                        <h2 class="text-2xl font-bold mb-2 theme-text-heading">${utils.t('welcome')}</h2>
                        <p class="theme-text-sub mb-8">${utils.t('add_first')}</p>
                        <button onclick="ui.openAddVehicle()" class="bg-sky-500 text-white px-8 py-3 rounded-2xl shadow-lg shadow-sky-200 font-semibold active:scale-95 transition transform">
                            ${utils.t('add_vehicle')}
                        </button>
                    </div>
                `;
            },

            renderFilterHeader(title, icon, pageType, isDark = false) {
                const filter = store.pageFilters[pageType];
                const years = utils.getAvailableYears();
                const currentYear = new Date().getFullYear().toString();

                const pillClass = (mode) => `px-3 py-1 rounded-full transition-all uppercase text-[10px] sm:text-xs ${filter.mode === mode ? (isDark ? 'bg-white text-sky-600 shadow-sm font-bold' : 'bg-white dark:bg-slate-500 theme-text-heading shadow-sm font-bold') : (isDark ? 'text-white/80 hover:bg-white/10' : 'text-slate-500 dark:text-slate-400')}`;

                let inputHtml = '';
                if (filter.mode === 'month') {
                    inputHtml = `<input type="month" value="${filter.value}" onchange="store.pageFilters['${pageType}'].value=this.value;ui.render()" class="bg-white/20 backdrop-blur text-center text-xs font-bold py-1 px-2 rounded-lg outline-none h-7 ${isDark ? 'text-white placeholder-white/50' : 'text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-600'}">`;
                } else if (filter.mode === 'year') {
                    inputHtml = `
                        <select onchange="store.pageFilters['${pageType}'].value=this.value;ui.render()" class="bg-white/20 backdrop-blur text-center text-xs font-bold py-1 px-2 rounded-lg outline-none h-7 ${isDark ? 'text-slate-800' : 'text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-600'}">
                            ${years.map(y => `<option value="${y}" ${filter.value == y ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>`;
                }

                if (isDark) {
                    const vehicle = store.getActiveVehicle();
                    const carIcon = vehicle ? utils.getCarIcon(vehicle) : icon;
                    return `
                        <div class="flex justify-between items-start pt-safe px-6 pb-20 text-white relative z-10">
                            <div class="flex-1">
                                <div class="text-sm opacity-80 font-medium tracking-wider mb-1 flex items-center gap-2">
                                    <span class="material-icons text-lg">${carIcon}</span>
                                    <span>${vehicle ? vehicle.year + ' ' + vehicle.make : ''}</span>
                                </div>
                                <div class="text-3xl font-bold flex items-center gap-2">
                                    ${title}
                                    ${pageType === 'dashboard' ? `<button onclick="ui.openAddVehicle(store.getActiveVehicle().id)" class="ml-2 p-1 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur transition"><span class="material-icons text-lg">edit</span></button>` : ''}
                                </div>
                            </div>
                            ${pageType === 'dashboard' ? 
                            `<div class="flex gap-2">
                                <button onclick="ui.openCalendarSelector()" class="bg-white/20 backdrop-blur-md p-2 rounded-full hover:bg-white/30 transition"><span class="material-icons text-white">today</span></button>
                                <button onclick="ui.openVehicleSelector()" class="bg-white/20 backdrop-blur-md p-2 rounded-full hover:bg-white/30 transition"><span class="material-icons text-white">swap_horiz</span></button>
                            </div>` : ''}
                        </div>
                        <div class="absolute bottom-6 w-full flex flex-row items-center justify-center gap-2 z-20 px-4">
                             ${inputHtml}
                             <div class="bg-black/20 backdrop-blur-md p-1 rounded-full flex shrink-0">
                                 <button onclick="store.pageFilters['${pageType}'] = {mode:'month', value:'${new Date().toISOString().slice(0,7)}'};ui.render()" class="${pillClass('month')}">${utils.t('mode_month')}</button>
                                 <button onclick="store.pageFilters['${pageType}'] = {mode:'year', value:'${currentYear}'};ui.render()" class="${pillClass('year')}">${utils.t('mode_year')}</button>
                                 <button onclick="store.pageFilters['${pageType}'] = {mode:'all', value:''};ui.render()" class="${pillClass('all')}">${utils.t('mode_all')}</button>
                             </div>
                        </div>
                    `;
                }

                return `
                    <div class="sticky-header px-6 pb-4 border-b theme-border z-30 flex flex-col gap-3">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold theme-text-heading flex items-center gap-2"><span class="material-icons text-sky-500">${icon}</span> ${title}</h1>
                            ${pageType === 'maintenance' ? `
                                <div class="relative">
                                    <input type="text" placeholder="${utils.t('search')}" value="${store.pageFilters.maintenanceSearch}" oninput="store.pageFilters.maintenanceSearch=this.value;ui.render()" class="pl-8 pr-3 py-1 rounded-full text-sm bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 focus:ring-sky-500 w-32 focus:w-48 transition-all">
                                    <span class="material-icons absolute left-2 top-1.5 text-slate-400 text-sm">search</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex justify-end items-center gap-2">
                            ${inputHtml}
                            <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-full flex">
                                <button onclick="store.pageFilters['${pageType}'] = {mode:'month', value:'${new Date().toISOString().slice(0,7)}'};ui.render()" class="${pillClass('month')}">${utils.t('mode_month')}</button>
                                <button onclick="store.pageFilters['${pageType}'] = {mode:'year', value:'${currentYear}'};ui.render()" class="${pillClass('year')}">${utils.t('mode_year')}</button>
                                <button onclick="store.pageFilters['${pageType}'] = {mode:'all', value:''};ui.render()" class="${pillClass('all')}">${utils.t('mode_all')}</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderDashboard(app, vehicle) {
                const stats = utils.calculateStats(store.pageFilters.dashboard);
                const logs = store.getVehicleLogs();
                
                // Reminders logic
                const now = new Date();
                const reminders = [];
                const logTypes = ['license', 'insurance', 'registration'];
                
                logTypes.forEach(type => {
                    const setting = store.data.settings.reminders[type];
                    if (setting && setting.enabled) {
                        // Find latest log of this type
                        const typeLogs = logs.filter(l => l.type === type).sort((a,b) => new Date(b.date) - new Date(a.date));
                        if (typeLogs.length > 0 && typeLogs[0].expiryDate) {
                            const exp = new Date(typeLogs[0].expiryDate);
                            const diffTime = exp - now;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            if (diffDays <= setting.days) {
                                reminders.push({
                                    title: utils.t(type + '_renewal'),
                                    days: diffDays,
                                    cost: typeLogs[0].cost,
                                    date: typeLogs[0].expiryDate,
                                    isExpired: diffDays < 0
                                });
                            }
                        }
                    }
                });

                // Periodic Maintenance Logic
                if (store.data.settings.maintenance) {
                     const mSettings = store.data.settings.maintenance;
                     const lastMaint = logs.filter(l => l.type === 'periodic_maintenance').sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                     
                     if (lastMaint) {
                         // Mileage Check
                         if (mSettings.kmInterval > 0) {
                             const nextOdo = parseInt(lastMaint.odometer) + parseInt(mSettings.kmInterval);
                             const diffOdo = nextOdo - vehicle.currentOdometer;
                             if (diffOdo <= 500) {
                                 reminders.push({
                                     title: utils.t('periodic_maintenance'),
                                     desc: `${utils.t('due_in')} ${diffOdo} ${utils.getDistUnit()}`,
                                     isExpired: diffOdo < 0,
                                     isService: true
                                 });
                             }
                         }
                         // Time Check
                         if (mSettings.timeInterval > 0) {
                             const nextDate = new Date(lastMaint.date);
                             nextDate.setMonth(nextDate.getMonth() + parseInt(mSettings.timeInterval));
                             const diffTime = nextDate - now;
                             const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                             if (diffDays <= 30) {
                                  reminders.push({
                                     title: utils.t('periodic_maintenance'),
                                     desc: `${utils.t('due_in')} ${diffDays} days`,
                                     isExpired: diffDays < 0,
                                     isService: true
                                 });
                             }
                         }
                     }
                }

                // Backup Reminder Logic
                let showBackup = false;
                if (!store.pageFilters.hideBackupBanner && logs.length > 0) {
                    const lastBackup = store.data.settings.lastBackupDate;
                    const daysSinceBackup = (Date.now() - lastBackup) / (1000 * 3600 * 24);
                    if (daysSinceBackup > 30) showBackup = true;
                }

                const gradientClass = utils.getVehicleGradient(vehicle.color || 'blue');

                app.innerHTML = `
                    <!-- Header -->
                    <div class="relative bg-gradient-to-br ${gradientClass} rounded-b-[2.5rem] shadow-2xl overflow-hidden transition-all duration-500">
                        ${this.renderFilterHeader(utils.t('t_dash'), 'dashboard', 'dashboard', true)}
                    </div>

                    <!-- Content -->
                    <div class="px-6 mt-2 pb-24 relative z-20">
                        
                        ${showBackup ? `
                        <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-xl shadow-sm flex justify-between items-start">
                            <div>
                                <h4 class="text-blue-800 font-bold text-sm flex items-center gap-1"><span class="material-icons text-sm">cloud_upload</span> ${utils.t('backup_reminder')}</h4>
                                <p class="text-blue-600 text-xs mt-1">${utils.t('backup_desc')}</p>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="ui.exportJSON()" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-lg shadow">${utils.t('backup_now')}</button>
                                <button onclick="store.pageFilters.hideBackupBanner=true;ui.render()" class="text-xs text-blue-400">${utils.t('remind_later')}</button>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Reminders -->
                        ${reminders.length > 0 ? `
                            <div class="mb-6 space-y-3">
                                <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest ml-1">${utils.t('reminders')}</h3>
                                ${reminders.map(r => `
                                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border-l-4 ${r.isExpired ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 'border-amber-500 bg-amber-50 dark:bg-amber-900/20'} flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <div class="p-2 rounded-full ${r.isExpired ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-600'}">
                                                <span class="material-icons">${r.isService ? 'build' : 'priority_high'}</span>
                                            </div>
                                            <div>
                                                <div class="font-bold ${r.isExpired ? 'text-red-800 dark:text-red-300' : 'text-amber-800 dark:text-amber-300'}">${r.title}</div>
                                                <div class="text-xs opacity-80 theme-text-main">${r.desc ? r.desc : (r.isExpired ? utils.t('expired') : `${r.days} ${utils.t('days_left')}`)}</div>
                                            </div>
                                        </div>
                                        ${r.cost ? `<div class="font-bold theme-text-heading">${utils.formatCurrency(r.cost)}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            ${this.renderStatsCard(utils.t('efficiency'), stats.efficiency > 0 ? stats.efficiency.toFixed(1) : '--', utils.getEfficiencyLabel())}
                            ${this.renderStatsCard(utils.t('cost_km'), stats.costPerKm > 0 ? utils.formatCurrency(stats.costPerKm) : '--', `/${utils.getDistUnit()}`)}
                            ${this.renderStatsCard(utils.t('total_cost'), utils.formatCurrency(stats.totalCost))}
                            ${this.renderStatsCard(utils.t('total_distance'), stats.totalDist, utils.getDistUnit())}
                        </div>

                        <!-- Quick Actions -->
                        <div class="grid grid-cols-2 gap-4 mb-8">
                            <button onclick="ui.openAddFuel()" class="group relative overflow-hidden bg-gradient-to-br from-teal-400 to-teal-600 text-white p-4 rounded-2xl shadow-lg shadow-teal-200 dark:shadow-none flex flex-col items-center justify-center gap-2 transition transform active:scale-95">
                                <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition"></div>
                                <span class="material-icons text-3xl">local_gas_station</span>
                                <span class="font-bold">${utils.t('add_fuel')}</span>
                            </button>
                            <button onclick="ui.openAddService()" class="group relative overflow-hidden bg-white dark:bg-slate-800 theme-text-heading p-4 rounded-2xl shadow-lg shadow-slate-200 dark:shadow-none border theme-border flex flex-col items-center justify-center gap-2 transition transform active:scale-95">
                                <span class="material-icons text-3xl text-slate-400 group-hover:text-sky-500 transition">build</span>
                                <span class="font-bold group-hover:text-sky-500 transition">${utils.t('add_service')}</span>
                            </button>
                        </div>

                        <!-- Recent Activity -->
                        <div>
                            <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-3 ml-1">${utils.t('recent_activity')}</h3>
                            <div class="space-y-3">
                                ${logs.slice(0, 5).map(log => this.renderLogCard(log)).join('') || `<div class="text-center text-slate-400 py-8 italic text-sm">${utils.t('no_records')}</div>`}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderFuel(app, vehicle) {
                const stats = utils.calculateStats(store.pageFilters.fuel, 'fuel');
                const logs = utils.filterLogs(store.getVehicleLogs('fuel'), store.pageFilters.fuel);

                app.innerHTML = `
                    ${this.renderFilterHeader(utils.t('t_fuel'), 'local_gas_station', 'fuel')}
                    <div class="px-4 mt-4 pb-24">
                         <div class="grid grid-cols-2 gap-3 mb-6">
                            ${this.renderStatsCard(utils.t('efficiency'), stats.efficiency > 0 ? stats.efficiency.toFixed(1) : '--', utils.getEfficiencyLabel())}
                            ${this.renderStatsCard(utils.t('cost_km'), stats.costPerKm > 0 ? utils.formatCurrency(stats.costPerKm) : '--', `/${utils.getDistUnit()}`)}
                            ${this.renderStatsCard(utils.t('total_cost'), utils.formatCurrency(stats.totalCost))}
                            ${this.renderStatsCard(utils.t('total_distance'), stats.totalDist, utils.getDistUnit())}
                        </div>

                        <div class="space-y-3">
                             ${logs.map(log => this.renderLogCard(log)).join('') || `<div class="text-center text-slate-400 py-12 italic">${utils.t('no_records')}</div>`}
                        </div>
                    </div>
                    <button onclick="ui.openAddFuel()" class="fixed bottom-24 right-6 bg-gradient-to-r from-teal-400 to-teal-600 text-white w-14 h-14 rounded-full flex items-center justify-center fab-shadow active:scale-90 transition transform z-30">
                        <span class="material-icons text-3xl">add</span>
                    </button>
                `;
            },

            renderMaintenance(app, vehicle) {
                const stats = utils.calculateStats(store.pageFilters.maintenance, 'maintenance');
                const allLogs = store.getVehicleLogs('maintenance');
                // Filter by Search
                const search = store.pageFilters.maintenanceSearch.toLowerCase();
                let logs = utils.filterLogs(allLogs, store.pageFilters.maintenance);
                
                if (search) {
                    logs = logs.filter(l => 
                        (l.notes && l.notes.toLowerCase().includes(search)) || 
                        (l.location && l.location.toLowerCase().includes(search)) ||
                        utils.t(l.type).toLowerCase().includes(search) ||
                        l.cost.toString().includes(search)
                    );
                }

                app.innerHTML = `
                    ${this.renderFilterHeader(utils.t('maintenance'), 'build', 'maintenance')}
                    <div class="px-4 mt-4 pb-24">
                        <div class="mb-6">
                             ${this.renderStatsCard(utils.t('service_cost'), utils.formatCurrency(stats.totalCost), '', 'w-full')}
                        </div>
                        <div class="space-y-3">
                             ${logs.map(log => this.renderLogCard(log)).join('') || `<div class="text-center text-slate-400 py-12 italic">${utils.t('no_records')}</div>`}
                        </div>
                    </div>
                    <button onclick="ui.openAddService()" class="fixed bottom-24 right-6 bg-gradient-to-r from-indigo-500 to-purple-600 text-white w-14 h-14 rounded-full flex items-center justify-center fab-shadow active:scale-90 transition transform z-30">
                        <span class="material-icons text-3xl">add</span>
                    </button>
                `;
            },
            
            renderParking(app, vehicle) {
                const stats = utils.calculateStats(store.pageFilters.parking, 'parking');
                const logs = utils.filterLogs(store.getVehicleLogs('parking'), store.pageFilters.parking);

                app.innerHTML = `
                     ${this.renderFilterHeader(utils.t('t_parking'), 'local_parking', 'parking')}
                     <div class="px-4 mt-4 pb-24">
                        <div class="mb-6">
                             ${this.renderStatsCard(utils.t('parking_cost'), utils.formatCurrency(stats.totalCost), '', 'w-full')}
                        </div>
                        <div class="space-y-3">
                             ${logs.map(log => this.renderLogCard(log)).join('') || `<div class="text-center text-slate-400 py-12 italic">${utils.t('no_records')}</div>`}
                        </div>
                    </div>
                    <button onclick="ui.openAddParking()" class="fixed bottom-24 right-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center fab-shadow active:scale-90 transition transform z-30">
                        <span class="material-icons text-3xl">add</span>
                    </button>
                `;
            },

            renderAnalytics(app, vehicle) {
                const logs = utils.filterLogs(store.getVehicleLogs(), store.pageFilters.analytics);
                
                // Pie Chart Data
                const breakdown = { fuel: 0, service: 0, fixed: 0 };
                logs.forEach(l => {
                    const cost = parseFloat(l.cost || 0);
                    if (l.type === 'fuel') breakdown.fuel += cost;
                    else if (['license', 'insurance', 'registration'].includes(l.type)) breakdown.fixed += cost;
                    else breakdown.service += cost;
                });
                const total = breakdown.fuel + breakdown.service + breakdown.fixed;
                
                // Pie Chart SVG
                const createPieSlice = (startPct, pct, color) => {
                    if (pct === 0) return '';
                    const startAngle = startPct * 360 * (Math.PI/180);
                    const endAngle = (startPct + pct) * 360 * (Math.PI/180);
                    const x1 = 50 + 50 * Math.cos(startAngle);
                    const y1 = 50 + 50 * Math.sin(startAngle);
                    const x2 = 50 + 50 * Math.cos(endAngle);
                    const y2 = 50 + 50 * Math.sin(endAngle);
                    const largeArc = pct > 0.5 ? 1 : 0;
                    return `<path d="M50,50 L${x1},${y1} A50,50 0 ${largeArc},1 ${x2},${y2} Z" fill="${color}" />`;
                };
                
                const pFuel = total ? breakdown.fuel / total : 0;
                const pService = total ? breakdown.service / total : 0;
                const pFixed = total ? breakdown.fixed / total : 0;

                app.innerHTML = `
                    ${this.renderFilterHeader(utils.t('t_analytics'), 'pie_chart', 'analytics')}
                    <div class="px-4 mt-4 pb-24">
                        <!-- Charts Container -->
                        <div class="space-y-6">
                            
                            <!-- Trend Chart -->
                            <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-4">${utils.t('trend_chart')} (${utils.getEfficiencyLabel()})</h3>
                                <div class="h-24">
                                    ${utils.generateTrendChart(logs)}
                                </div>
                            </div>

                            <!-- Monthly Bar Chart -->
                            <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-4">${utils.t('bar_chart')}</h3>
                                <div class="h-32">
                                    ${utils.generateBarChart(logs)}
                                </div>
                            </div>

                            <!-- Expense Breakdown -->
                            <div class="theme-bg-card p-6 rounded-2xl card-shadow flex items-center gap-6">
                                <div class="w-32 h-32 relative shrink-0">
                                    <svg viewBox="0 0 100 100" class="transform -rotate-90 w-full h-full rounded-full overflow-hidden shadow-inner">
                                        ${total === 0 ? '<circle cx="50" cy="50" r="50" fill="#e2e8f0" />' : `
                                            ${createPieSlice(0, pFuel, '#14b8a6')}
                                            ${createPieSlice(pFuel, pService, '#6366f1')}
                                            ${createPieSlice(pFuel + pService, pFixed, '#f59e0b')}
                                        `}
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                                        <span class="text-xs theme-text-sub">Total</span>
                                        <span class="font-bold text-sm theme-text-heading">${utils.formatCurrency(total)}</span>
                                    </div>
                                </div>
                                <div class="flex-1 space-y-3 text-sm">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-teal-500"></div><span class="theme-text-main">${utils.t('t_fuel')}</span></div>
                                        <span class="font-bold theme-text-heading">${utils.formatCurrency(breakdown.fuel)}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-indigo-500"></div><span class="theme-text-main">${utils.t('t_service')}</span></div>
                                        <span class="font-bold theme-text-heading">${utils.formatCurrency(breakdown.service)}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-500"></div><span class="theme-text-main">${utils.t('fixed_costs')}</span></div>
                                        <span class="font-bold theme-text-heading">${utils.formatCurrency(breakdown.fixed)}</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                `;
            },

            renderSettings(app) {
                const s = store.data.settings;
                const vehicles = store.data.vehicles;
                
                app.innerHTML = `
                    <div class="sticky-header px-6 pb-4 border-b theme-border z-30">
                        <h1 class="text-3xl font-bold theme-text-heading">${utils.t('settings_title')}</h1>
                    </div>
                    <div class="px-4 mt-6 pb-24 space-y-6">
                        
                        <!-- Vehicles -->
                        <section>
                            <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-3 ml-1">${utils.t('manage_vehicles')}</h3>
                            <div class="theme-bg-card rounded-2xl card-shadow overflow-hidden">
                                ${vehicles.map(v => `
                                    <div class="p-4 border-b theme-border flex justify-between items-center ${s.activeVehicleId === v.id ? 'bg-sky-50 dark:bg-sky-900/10' : ''}" onclick="store.data.settings.activeVehicleId='${v.id}';store.save()">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white ${utils.getCarColorClass(v)}">
                                                <span class="material-icons">${utils.getCarIcon(v)}</span>
                                            </div>
                                            <div>
                                                <div class="font-bold theme-text-heading">${v.year} ${v.make}</div>
                                                <div class="text-xs theme-text-sub">${v.model} ${s.activeVehicleId === v.id ? ' (Active)' : ''}</div>
                                            </div>
                                        </div>
                                        <button onclick="event.stopPropagation();ui.openAddVehicle('${v.id}')" class="text-sky-500 p-2"><span class="material-icons">edit</span></button>
                                    </div>
                                `).join('')}
                                <button onclick="ui.openAddVehicle()" class="w-full p-4 text-center text-sky-500 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                                    + ${utils.t('add_vehicle')}
                                </button>
                            </div>
                        </section>

                        <!-- Notifications -->
                        <section>
                            <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-3 ml-1">${utils.t('notif_settings')}</h3>
                            <div class="theme-bg-card rounded-2xl card-shadow p-4 space-y-4">
                                ${['license', 'insurance', 'registration'].map(type => `
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold theme-text-heading">${utils.t(type + '_renewal')}</div>
                                            <div class="text-xs theme-text-sub">${utils.t('reminder_timing')}</div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <select onchange="store.data.settings.reminders['${type}'].days=parseInt(this.value);store.save()" class="bg-slate-100 dark:bg-slate-800 rounded-lg text-xs p-2 theme-text-main outline-none">
                                                <option value="0" ${s.reminders[type].days === 0 ? 'selected' : ''}>${utils.t('day_0')}</option>
                                                <option value="7" ${s.reminders[type].days === 7 ? 'selected' : ''}>${utils.t('day_7')}</option>
                                                <option value="30" ${s.reminders[type].days === 30 ? 'selected' : ''}>${utils.t('day_30')}</option>
                                            </select>
                                            <div onclick="store.data.settings.reminders['${type}'].enabled = !store.data.settings.reminders['${type}'].enabled; store.save()" class="w-12 h-6 rounded-full relative cursor-pointer transition-colors duration-300 ${s.reminders[type].enabled ? 'bg-sky-500' : 'bg-slate-300'}">
                                                <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform duration-300 shadow-sm ${s.reminders[type].enabled ? 'left-7' : 'left-1'}"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>

                         <!-- Service Interval Settings -->
                        <section>
                            <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-3 ml-1">${utils.t('service_settings')}</h3>
                            <div class="theme-bg-card rounded-2xl card-shadow p-4 space-y-4">
                                <div class="flex items-center justify-between">
                                    <div class="font-bold theme-text-heading">${utils.t('service_interval')} (Distance)</div>
                                    <select onchange="store.data.settings.maintenance.kmInterval=parseInt(this.value);store.save()" class="bg-slate-100 dark:bg-slate-800 rounded-lg text-xs p-2 theme-text-main outline-none">
                                        <option value="0" ${s.maintenance.kmInterval === 0 ? 'selected' : ''}>${utils.t('off')}</option>
                                        <option value="5000" ${s.maintenance.kmInterval === 5000 ? 'selected' : ''}>${utils.t('km_5000')}</option>
                                        <option value="10000" ${s.maintenance.kmInterval === 10000 ? 'selected' : ''}>${utils.t('km_10000')}</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="font-bold theme-text-heading">${utils.t('service_interval')} (Time)</div>
                                    <select onchange="store.data.settings.maintenance.timeInterval=parseInt(this.value);store.save()" class="bg-slate-100 dark:bg-slate-800 rounded-lg text-xs p-2 theme-text-main outline-none">
                                        <option value="0" ${s.maintenance.timeInterval === 0 ? 'selected' : ''}>${utils.t('off')}</option>
                                        <option value="6" ${s.maintenance.timeInterval === 6 ? 'selected' : ''}>${utils.t('m_6')}</option>
                                        <option value="12" ${s.maintenance.timeInterval === 12 ? 'selected' : ''}>${utils.t('m_12')}</option>
                                    </select>
                                </div>
                            </div>
                        </section>

                        <!-- App Settings -->
                        <section>
                            <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-3 ml-1">${utils.t('app_settings')}</h3>
                            <div class="theme-bg-card rounded-2xl card-shadow p-4 space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="theme-text-main">${utils.t('units')}</span>
                                    <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-lg flex">
                                        <button onclick="store.data.settings.units='metric';store.save()" class="px-3 py-1 rounded-md text-xs transition ${s.units === 'metric' ? 'bg-white dark:bg-slate-600 shadow text-sky-600 font-bold' : 'text-slate-500'}">Metric</button>
                                        <button onclick="store.data.settings.units='imperial';store.save()" class="px-3 py-1 rounded-md text-xs transition ${s.units === 'imperial' ? 'bg-white dark:bg-slate-600 shadow text-sky-600 font-bold' : 'text-slate-500'}">Imperial</button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="theme-text-main">${utils.t('language')}</span>
                                    <div class="bg-slate-100 dark:bg-slate-800 p-1 rounded-lg flex">
                                        <button onclick="store.data.settings.language='en';store.save()" class="px-3 py-1 rounded-md text-xs transition ${s.language === 'en' ? 'bg-white dark:bg-slate-600 shadow text-sky-600 font-bold' : 'text-slate-500'}">English</button>
                                        <button onclick="store.data.settings.language='zh';store.save()" class="px-3 py-1 rounded-md text-xs transition ${s.language === 'zh' ? 'bg-white dark:bg-slate-600 shadow text-sky-600 font-bold' : 'text-slate-500'}">中文</button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="theme-text-main">${utils.t('currency')}</span>
                                    <select onchange="store.data.settings.currency=this.value;store.save()" class="bg-slate-100 dark:bg-slate-800 rounded-lg p-2 text-xs theme-text-heading outline-none">
                                        ${['$', '€', '£', '¥', 'HK$', 'A$'].map(c => `<option value="${c}" ${s.currency === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </section>

                        <!-- Data -->
                        <section class="space-y-3">
                            <button onclick="ui.exportJSON()" class="w-full bg-sky-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-sky-200 dark:shadow-none active:scale-95 transition">${utils.t('export_json')}</button>
                            <button onclick="ui.importJSON()" class="w-full bg-white dark:bg-slate-800 theme-text-heading font-bold py-3 rounded-xl border theme-border active:scale-95 transition">${utils.t('import_json')}</button>
                            <button onclick="ui.exportCSV()" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-200 dark:shadow-none active:scale-95 transition">${utils.t('export_csv')}</button>
                            <input type="file" id="import-file" class="hidden" onchange="ui.handleImport(this)">
                        </section>

                        <!-- About -->
                         <section class="pt-8 flex justify-center">
                            <button onclick="ui.openAboutModal()" class="flex flex-col items-center gap-2 opacity-50 hover:opacity-100 transition">
                                <div class="w-12 h-12 bg-gradient-to-br from-sky-400 to-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                                    <span class="material-icons">local_gas_station</span>
                                </div>
                                <span class="text-xs font-bold text-slate-500">${utils.t('about_app')}</span>
                            </button>
                        </section>
                    </div>
                `;
            },

            renderStatsCard(title, value, unit = '', wClass='') {
                return `
                    <div class="theme-bg-card p-4 rounded-2xl card-shadow flex flex-col justify-center ${wClass}">
                        <span class="text-[10px] font-bold theme-text-sub uppercase tracking-widest mb-1">${title}</span>
                        <div class="flex items-baseline gap-1">
                            <span class="text-xl font-bold theme-text-heading">${value}</span>
                            ${unit ? `<span class="text-xs theme-text-sub">${unit}</span>` : ''}
                        </div>
                    </div>
                `;
            },

            renderLogCard(log) {
                const vehicle = store.data.vehicles.find(v => v.id === log.vehicleId);
                const date = utils.formatDate(log.date);
                let icon = 'edit_note';
                let colorClass = 'bg-slate-100 text-slate-600';
                let title = utils.t(log.type);
                
                if (log.type === 'fuel') { 
                    icon = 'local_gas_station'; 
                    colorClass = 'bg-teal-50 text-teal-600'; 
                } else if (log.type === 'parking') {
                    icon = 'local_parking';
                    colorClass = 'bg-blue-50 text-blue-600';
                } else if (log.type === 'fine') {
                    icon = 'local_police';
                    colorClass = 'bg-red-50 text-red-600';
                    if (log.notes) title = utils.t(log.notes.split(',')[0]); // Use first tag as title
                } else if (['license', 'insurance', 'registration'].includes(log.type)) {
                    icon = 'assignment';
                    colorClass = 'bg-purple-50 text-purple-600';
                } else if (log.type === 'periodic_maintenance') {
                    icon = 'update';
                    colorClass = 'bg-amber-50 text-amber-600';
                } else if (log.type === 'car_wash') {
                     icon = 'local_car_wash';
                     colorClass = 'bg-cyan-50 text-cyan-600';
                } else if (log.type === 'car_accessories') {
                     icon = 'shopping_bag';
                     colorClass = 'bg-pink-50 text-pink-600';
                }

                // Fuel Stats Logic
                let fuelStatsHtml = '';
                if (log.type === 'fuel') {
                    const allFuel = store.getVehicleLogs('fuel');
                    const idx = allFuel.findIndex(l => l.id === log.id);
                    let l100 = '--', costKm = '--';
                    
                    if (idx < allFuel.length - 1) {
                        const prev = allFuel[idx+1];
                        if (!log.isPartial && !prev.isPartial) {
                             const dist = log.odometer - prev.odometer;
                             if (dist > 0) {
                                 l100 = ((log.liters / dist) * 100).toFixed(1);
                                 costKm = (log.cost / dist).toFixed(2);
                             }
                        }
                    }
                    
                    fuelStatsHtml = `
                        <div class="mt-3 pt-3 border-t theme-border flex justify-between text-xs">
                            <div>
                                <div class="theme-text-sub mb-0.5 uppercase tracking-wider text-[10px]">${utils.getEfficiencyLabel()}</div>
                                <div class="font-bold text-teal-600 text-sm">${l100}</div>
                            </div>
                             <div class="text-right">
                                <div class="theme-text-sub mb-0.5 uppercase tracking-wider text-[10px]">${utils.t('cost_km')}</div>
                                <div class="font-bold text-teal-600 text-sm">${utils.formatCurrency(costKm)}</div>
                            </div>
                        </div>
                    `;
                }
                
                // Location Link Logic
                let locHtml = '';
                if (log.location) {
                    locHtml = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(log.location)}" target="_blank" class="text-xs text-sky-500 hover:underline flex items-center gap-1 mt-1" onclick="event.stopPropagation()"><span class="material-icons text-[10px]">place</span>${log.location}</a>`;
                }

                return `
                    <div class="theme-bg-card p-4 rounded-2xl card-shadow relative group">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${colorClass}">
                                    <span class="material-icons">${icon}</span>
                                </div>
                                <div>
                                    <div class="font-bold text-sm theme-text-heading">${date}</div>
                                    <div class="text-xs theme-text-heading font-semibold mt-0.5">${title} ${log.isPartial ? '<span class="text-amber-500 text-[10px] border border-amber-500 px-1 rounded ml-1">PARTIAL</span>' : ''}</div>
                                    <div class="text-xs theme-text-sub mt-0.5">${log.odometer} ${utils.getDistUnit()}</div>
                                    ${locHtml}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold theme-text-heading">${utils.formatCurrency(log.cost)}</div>
                                <button onclick="ui.openAdd${log.type === 'fuel' ? 'Fuel' : (log.type === 'parking' ? 'Parking' : 'Service')}('${log.id}')" class="text-slate-300 hover:text-sky-500 mt-2"><span class="material-icons text-lg">edit</span></button>
                            </div>
                        </div>
                        ${fuelStatsHtml}
                        ${log.notes && log.type !== 'fine' ? `<div class="mt-2 text-xs theme-text-sub bg-slate-50 dark:bg-slate-800 p-2 rounded-lg italic">${log.notes}</div>` : ''}
                    </div>
                `;
            },

            /* --- MODALS --- */
            
            openModal(html) {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                content.innerHTML = html;
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                
                // Click outside to close
                overlay.onclick = (e) => {
                    if (e.target === overlay) this.closeModal();
                };
            },
            closeModal() {
                const overlay = document.getElementById('modal-overlay');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            },

            openAddVehicle(id = null) {
                const v = id ? store.data.vehicles.find(v => v.id === id) : null;
                const isEdit = !!v;
                
                // Color Palette
                const colors = ['blue','red','black','white','silver','green','yellow','orange','purple','brown','grey','dark_red','dark_green','cyan','pink','teal','gold'];
                
                this.openModal(`
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-6 theme-text-heading">${isEdit ? utils.t('edit_vehicle') : utils.t('add_vehicle')}</h2>
                        <form onsubmit="event.preventDefault(); ui.submitVehicle('${id || ''}')" class="space-y-4">
                            <input type="text" id="v-make" placeholder="Make (e.g. Honda)" value="${v?.make || ''}" class="w-full p-3 rounded-xl input-field outline-none" required>
                            <input type="text" id="v-model" placeholder="Model (e.g. Civic)" value="${v?.model || ''}" class="w-full p-3 rounded-xl input-field outline-none" required>
                            <input type="number" id="v-year" placeholder="Year" value="${v?.year || ''}" class="w-full p-3 rounded-xl input-field outline-none" required>
                            <input type="number" id="v-odo" placeholder="Current Odometer" value="${v?.currentOdometer || ''}" class="w-full p-3 rounded-xl input-field outline-none" required>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold theme-text-sub uppercase ml-1 block mb-2">${utils.t('vehicle_type')}</label>
                                    <select id="v-type" class="w-full p-3 rounded-xl input-field outline-none">
                                        ${['sedan', 'suv', 'truck', 'bike', 'sports', 'van', 'bus'].map(t => `<option value="${t}" ${v?.type === t ? 'selected' : ''}>${utils.t('c_'+t)}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold theme-text-sub uppercase ml-1 block mb-2">${utils.t('fuel_unit')}</label>
                                    <select id="v-fuelUnit" class="w-full p-3 rounded-xl input-field outline-none">
                                        <option value="L" ${v?.fuelUnit === 'L' ? 'selected' : ''}>L (Liters)</option>
                                        <option value="gal" ${v?.fuelUnit === 'gal' ? 'selected' : ''}>gal (Gallons)</option>
                                        <option value="kWh" ${v?.fuelUnit === 'kWh' ? 'selected' : ''}>kWh (EV)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1 block mb-2">${utils.t('vehicle_color')}</label>
                                <div class="grid grid-cols-6 gap-3" id="color-grid">
                                    ${colors.map(c => `
                                        <div onclick="ui.selectColor('${c}')" class="color-dot w-8 h-8 rounded-full cursor-pointer ring-2 ring-offset-2 ${v?.color === c ? 'ring-sky-500' : 'ring-transparent'} ${utils.getCarColorClass({color:c})}"></div>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="v-color" value="${v?.color || 'blue'}">
                            </div>

                            <div class="flex gap-3 pt-4">
                                ${isEdit ? `<button type="button" onclick="ui.deleteVehicle('${v.id}')" class="flex-1 bg-red-50 text-red-500 font-bold py-3 rounded-xl hover:bg-red-100 transition">${utils.t('delete')}</button>` : ''}
                                <button type="submit" class="flex-1 bg-sky-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-sky-200 dark:shadow-none hover:bg-sky-600 transition">${utils.t('save')}</button>
                            </div>
                            
                            ${isEdit ? `
                            <div class="pt-6 border-t theme-border mt-4">
                                <button type="button" onclick="ui.clearVehicleData('${v.id}')" class="w-full text-red-500 text-xs font-bold border border-red-200 rounded-lg py-2 hover:bg-red-50 transition">${utils.t('clear_history')}</button>
                            </div>` : ''}
                        </form>
                    </div>
                `);
            },
            
            selectColor(color) {
                document.getElementById('v-color').value = color;
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('ring-sky-500'));
                document.querySelectorAll('.color-dot').forEach(d => d.classList.add('ring-transparent'));
                // Find the clicked one - simplified logic: redraw or just set class
                // Since we render inside HTML string, we rely on event target in real DOM but here we just re-render logic or use simple JS
                // Let's use a simpler approach:
                const dots = document.getElementById('color-grid').children;
                const colors = ['blue','red','black','white','silver','green','yellow','orange','purple','brown','grey','dark_red','dark_green','cyan','pink','teal','gold'];
                const idx = colors.indexOf(color);
                if(dots[idx]) {
                    dots[idx].classList.remove('ring-transparent');
                    dots[idx].classList.add('ring-sky-500');
                }
            },

            openAddFuel(id = null) {
                const log = id ? store.data.logs.find(l => l.id === id) : null;
                const today = new Date().toISOString().split('T')[0];
                const unit = utils.getFuelUnit();
                
                let tripVal = '';
                if (!id) {
                    // If adding new, find previous odometer to calculate trip
                    const logs = store.getVehicleLogs('fuel');
                    if (logs.length > 0) {
                         // tripVal = ... logic handled in toggle
                    }
                }

                this.openModal(`
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-6 theme-text-heading">${id ? utils.t('edit') : utils.t('add_fuel')}</h2>
                        <form onsubmit="event.preventDefault(); ui.submitFuel('${id || ''}')" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('date')}</label>
                                <input type="date" id="f-date" value="${log?.date || today}" class="w-full p-3 rounded-xl input-field outline-none" required>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('odometer')}</label>
                                    <div class="bg-slate-100 dark:bg-slate-800 p-0.5 rounded-lg flex text-[10px]">
                                        <button type="button" onclick="ui.toggleOdoInput('total')" id="btn-odo-total" class="px-2 py-1 rounded shadow bg-white dark:bg-slate-600 font-bold text-sky-600">${utils.t('odo_total')}</button>
                                        <button type="button" onclick="ui.toggleOdoInput('trip')" id="btn-odo-trip" class="px-2 py-1 rounded text-slate-400">${utils.t('odo_trip')}</button>
                                    </div>
                                </div>
                                <input type="number" id="f-odo" value="${log?.odometer || ''}" class="w-full p-3 rounded-xl input-field outline-none" required placeholder="${utils.t('odo_total')}">
                                <input type="number" id="f-trip" class="hidden w-full p-3 rounded-xl input-field outline-none" placeholder="${utils.t('odo_trip')} (+km)">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t(unit === 'kWh' ? 'kwh' : 'liters')}</label>
                                    <input type="number" step="0.01" id="f-liters" value="${log?.liters || ''}" oninput="ui.calcFuel('liters')" class="w-full p-3 rounded-xl input-field outline-none" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('price_unit')}</label>
                                    <input type="number" step="0.01" id="f-price" class="w-full p-3 rounded-xl input-field outline-none" oninput="ui.calcFuel('price')" placeholder="$0.00">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('cost')}</label>
                                <input type="number" step="0.01" id="f-cost" value="${log?.cost || ''}" oninput="ui.calcFuel('cost')" class="w-full p-3 rounded-xl input-field outline-none" required placeholder="$0.00">
                            </div>
                            <div>
                                <div class="flex justify-between">
                                    <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('location')}</label>
                                    <button type="button" onclick="utils.detectLocation('f-loc')" class="text-xs text-sky-500 font-bold flex items-center"><span class="material-icons text-xs mr-1">my_location</span>${utils.t('detect_loc')}</button>
                                </div>
                                <input type="text" id="f-loc" value="${log?.location || ''}" class="w-full p-3 rounded-xl input-field outline-none">
                            </div>
                            
                            <div class="flex items-start gap-2 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-100 dark:border-amber-900/30">
                                <input type="checkbox" id="f-partial" class="mt-1 rounded text-amber-500 focus:ring-amber-500" ${log?.isPartial ? 'checked' : ''}>
                                <div>
                                    <label for="f-partial" class="text-sm font-bold text-amber-800 dark:text-amber-500">${utils.t('partial_tank')}</label>
                                    <p class="text-xs text-amber-600/80 dark:text-amber-400/80 leading-tight mt-0.5">${utils.t('partial_desc')}</p>
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                ${id ? `<button type="button" onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-500 font-bold py-3 rounded-xl hover:bg-red-100 transition">${utils.t('delete')}</button>` : ''}
                                <button type="submit" class="flex-1 bg-teal-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-teal-200 dark:shadow-none hover:bg-teal-600 transition">${utils.t('save')}</button>
                            </div>
                        </form>
                    </div>
                `);
                if(log && log.cost && log.liters) {
                    document.getElementById('f-price').value = (log.cost / log.liters).toFixed(3);
                }
            },

            toggleOdoInput(mode) {
                const odoInput = document.getElementById('f-odo');
                const tripInput = document.getElementById('f-trip');
                const btnTotal = document.getElementById('btn-odo-total');
                const btnTrip = document.getElementById('btn-odo-trip');
                
                if (mode === 'trip') {
                    odoInput.classList.add('hidden');
                    tripInput.classList.remove('hidden');
                    tripInput.focus();
                    btnTrip.className = "px-2 py-1 rounded shadow bg-white dark:bg-slate-600 font-bold text-sky-600";
                    btnTotal.className = "px-2 py-1 rounded text-slate-400";
                } else {
                    odoInput.classList.remove('hidden');
                    tripInput.classList.add('hidden');
                    odoInput.focus();
                    btnTotal.className = "px-2 py-1 rounded shadow bg-white dark:bg-slate-600 font-bold text-sky-600";
                    btnTrip.className = "px-2 py-1 rounded text-slate-400";
                }
            },
            
            calcFuel(trigger) {
                const liters = parseFloat(document.getElementById('f-liters').value) || 0;
                const cost = parseFloat(document.getElementById('f-cost').value) || 0;
                const price = parseFloat(document.getElementById('f-price').value) || 0;
                
                if (trigger === 'liters' && price > 0) {
                    document.getElementById('f-cost').value = (liters * price).toFixed(2);
                } else if (trigger === 'price' && liters > 0) {
                    document.getElementById('f-cost').value = (liters * price).toFixed(2);
                } else if (trigger === 'cost' && liters > 0) {
                    document.getElementById('f-price').value = (cost / liters).toFixed(3);
                }
            },

            openAddService(id = null) {
                const log = id ? store.data.logs.find(l => l.id === id) : null;
                const today = new Date().toISOString().split('T')[0];
                
                this.openModal(`
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-6 theme-text-heading">${id ? utils.t('edit') : utils.t('add_service')}</h2>
                        <form onsubmit="event.preventDefault(); ui.submitService('${id || ''}')" class="space-y-4">
                             <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('type')}</label>
                                <select id="s-type" onchange="ui.handleTypeChange(this.value)" class="w-full p-3 rounded-xl input-field outline-none bg-white">
                                    <option value="maintenance" ${log?.type === 'maintenance' ? 'selected' : ''}>${utils.t('maintenance')}</option>
                                    <option value="periodic_maintenance" ${log?.type === 'periodic_maintenance' ? 'selected' : ''}>${utils.t('periodic_maintenance')}</option>
                                    <option value="car_wash" ${log?.type === 'car_wash' ? 'selected' : ''}>${utils.t('car_wash')}</option>
                                    <option value="car_accessories" ${log?.type === 'car_accessories' ? 'selected' : ''}>${utils.t('car_accessories')}</option>
                                    <option value="fine" ${log?.type === 'fine' ? 'selected' : ''}>${utils.t('t_fine')}</option>
                                    <option value="license" ${log?.type === 'license' ? 'selected' : ''}>${utils.t('license_renewal')}</option>
                                    <option value="insurance" ${log?.type === 'insurance' ? 'selected' : ''}>${utils.t('insurance_renewal')}</option>
                                    <option value="registration" ${log?.type === 'registration' ? 'selected' : ''}>${utils.t('registration')}</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('date')}</label>
                                <input type="date" id="s-date" value="${log?.date || today}" class="w-full p-3 rounded-xl input-field outline-none" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('odometer')}</label>
                                <input type="number" id="s-odo" value="${log?.odometer || ''}" class="w-full p-3 rounded-xl input-field outline-none" placeholder="Optional">
                            </div>
                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('cost')}</label>
                                <input type="number" step="0.01" id="s-cost" value="${log?.cost || ''}" class="w-full p-3 rounded-xl input-field outline-none" required placeholder="$0.00">
                            </div>
                            
                            <div id="field-expiry" class="hidden">
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1 text-sky-500">${utils.t('new_expiry')}</label>
                                <input type="date" id="s-expiry" value="${log?.expiryDate || today}" class="w-full p-3 rounded-xl input-field outline-none border-sky-300 focus:border-sky-500">
                            </div>

                            <div id="field-notes">
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('notes')}</label>
                                <!-- Quick Tags -->
                                <div class="flex flex-wrap gap-2 mb-2" id="quick-tags">
                                    ${['oil', 'filter', 'tires', 'battery', 'brakes', 'wipers', 'wash', 'aircon'].map(t => `<button type="button" onclick="ui.addTag('${utils.t('s_'+t)}')" class="text-[10px] bg-slate-100 dark:bg-slate-800 hover:bg-sky-100 hover:text-sky-600 px-2 py-1 rounded-md transition">${utils.t('s_'+t)}</button>`).join('')}
                                </div>
                                <div class="flex flex-wrap gap-2 mb-2 hidden" id="fine-tags">
                                    ${['parking', 'speeding', 'red_light', 'lane', 'phone'].map(t => `<button type="button" onclick="document.getElementById('s-notes').value='${utils.t('f_'+t)}'" class="text-[10px] bg-red-50 text-red-600 border border-red-100 px-2 py-1 rounded-md transition">${utils.t('f_'+t)}</button>`).join('')}
                                </div>
                                <textarea id="s-notes" rows="3" class="w-full p-3 rounded-xl input-field outline-none">${log?.notes || ''}</textarea>
                            </div>
                            <div id="field-loc">
                                <div class="flex justify-between">
                                    <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('location')}</label>
                                    <button type="button" onclick="utils.detectLocation('s-loc')" class="text-xs text-sky-500 font-bold flex items-center"><span class="material-icons text-xs mr-1">my_location</span>${utils.t('detect_loc')}</button>
                                </div>
                                <input type="text" id="s-loc" value="${log?.location || ''}" class="w-full p-3 rounded-xl input-field outline-none">
                            </div>

                            <div class="flex gap-3 pt-4">
                                ${id ? `<button type="button" onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-500 font-bold py-3 rounded-xl hover:bg-red-100 transition">${utils.t('delete')}</button>` : ''}
                                <button type="submit" class="flex-1 bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 dark:shadow-none hover:bg-indigo-600 transition">${utils.t('save')}</button>
                            </div>
                        </form>
                    </div>
                `);
                this.handleTypeChange(log?.type || 'maintenance');
            },
            
            addTag(tag) {
                const area = document.getElementById('s-notes');
                if(area.value) area.value += `, ${tag}`;
                else area.value = tag;
            },

            handleTypeChange(type) {
                const isDoc = ['license', 'insurance', 'registration'].includes(type);
                const isFine = type === 'fine';
                
                const expiry = document.getElementById('field-expiry');
                const notes = document.getElementById('field-notes');
                const loc = document.getElementById('field-loc');
                const quickTags = document.getElementById('quick-tags');
                const fineTags = document.getElementById('fine-tags');

                if (isDoc) {
                    expiry.classList.remove('hidden');
                    notes.classList.add('hidden');
                    loc.classList.add('hidden');
                } else {
                    expiry.classList.add('hidden');
                    notes.classList.remove('hidden');
                    loc.classList.remove('hidden');
                    
                    if (isFine) {
                        quickTags.classList.add('hidden');
                        fineTags.classList.remove('hidden');
                    } else {
                        quickTags.classList.remove('hidden');
                        fineTags.classList.add('hidden');
                    }
                }
            },

            openAddParking(id = null) {
                const log = id ? store.data.logs.find(l => l.id === id) : null;
                const today = new Date().toISOString().split('T')[0];

                this.openModal(`
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-6 theme-text-heading">${id ? utils.t('edit_parking') : utils.t('add_parking')}</h2>
                        <form onsubmit="event.preventDefault(); ui.submitParking('${id || ''}')" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('date')}</label>
                                <input type="date" id="p-date" value="${log?.date || today}" class="w-full p-3 rounded-xl input-field outline-none" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('cost')}</label>
                                <input type="number" step="0.01" id="p-cost" value="${log?.cost || ''}" class="w-full p-3 rounded-xl input-field outline-none" required placeholder="$0.00">
                            </div>
                            <div>
                                <div class="flex justify-between">
                                    <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('location')}</label>
                                    <button type="button" onclick="utils.detectLocation('p-loc')" class="text-xs text-sky-500 font-bold flex items-center"><span class="material-icons text-xs mr-1">my_location</span>${utils.t('detect_loc')}</button>
                                </div>
                                <input type="text" id="p-loc" value="${log?.location || ''}" class="w-full p-3 rounded-xl input-field outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-bold theme-text-sub uppercase ml-1">${utils.t('notes')}</label>
                                <textarea id="p-notes" rows="2" class="w-full p-3 rounded-xl input-field outline-none">${log?.notes || ''}</textarea>
                            </div>
                            <div class="flex gap-3 pt-4">
                                ${id ? `<button type="button" onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-500 font-bold py-3 rounded-xl hover:bg-red-100 transition">${utils.t('delete')}</button>` : ''}
                                <button type="submit" class="flex-1 bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-200 dark:shadow-none hover:bg-blue-600 transition">${utils.t('save')}</button>
                            </div>
                        </form>
                    </div>
                `);
            },

            /* --- SUBMIT HANDLERS --- */
            
            submitVehicle(id) {
                const v = {
                    id: id || utils.uuid(),
                    make: document.getElementById('v-make').value,
                    model: document.getElementById('v-model').value,
                    year: document.getElementById('v-year').value,
                    currentOdometer: document.getElementById('v-odo').value,
                    type: document.getElementById('v-type').value,
                    color: document.getElementById('v-color').value,
                    fuelUnit: document.getElementById('v-fuelUnit').value
                };
                if (id) store.updateVehicle(v); else store.addVehicle(v);
                this.closeModal();
            },
            
            submitFuel(id) {
                let odometer = document.getElementById('f-odo').value;
                const trip = document.getElementById('f-trip').value;
                
                // Trip Logic: If Trip mode is active (odo is hidden) or trip has value
                if (trip && !document.getElementById('f-trip').classList.contains('hidden')) {
                     const logs = store.getVehicleLogs('fuel');
                     const maxOdo = logs.length > 0 ? Math.max(...logs.map(l => parseInt(l.odometer))) : 0;
                     const baseOdo = maxOdo > 0 ? maxOdo : (parseInt(store.getActiveVehicle().currentOdometer) || 0);
                     odometer = baseOdo + parseInt(trip);
                }

                const log = {
                    id: id || utils.uuid(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: 'fuel',
                    date: document.getElementById('f-date').value,
                    odometer: odometer,
                    liters: document.getElementById('f-liters').value,
                    cost: document.getElementById('f-cost').value,
                    location: document.getElementById('f-loc').value,
                    isPartial: document.getElementById('f-partial').checked
                };
                if (id) store.updateLog(log); else store.addLog(log);
                this.closeModal();
            },

            submitService(id) {
                const type = document.getElementById('s-type').value;
                const isDoc = ['license', 'insurance', 'registration'].includes(type);
                
                const log = {
                    id: id || utils.uuid(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: type,
                    date: document.getElementById('s-date').value,
                    odometer: document.getElementById('s-odo').value,
                    cost: document.getElementById('s-cost').value,
                    expiryDate: isDoc ? document.getElementById('s-expiry').value : null,
                    notes: isDoc ? '' : document.getElementById('s-notes').value,
                    location: isDoc ? '' : document.getElementById('s-loc').value
                };
                if (id) store.updateLog(log); else store.addLog(log);
                this.closeModal();
            },

            submitParking(id) {
                const log = {
                    id: id || utils.uuid(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: 'parking',
                    date: document.getElementById('p-date').value,
                    cost: document.getElementById('p-cost').value,
                    location: document.getElementById('p-loc').value,
                    notes: document.getElementById('p-notes').value
                };
                if (id) store.updateLog(log); else store.addLog(log);
                this.closeModal();
            },

            deleteVehicle(id) {
                setTimeout(() => {
                    if(confirm(utils.t('confirm_delete'))) {
                        store.deleteVehicle(id);
                        this.closeModal();
                    }
                }, 50);
            },
            
            clearVehicleData(id) {
                setTimeout(() => {
                    if(confirm(utils.t('confirm_clear_1'))) {
                        setTimeout(() => {
                            if(confirm(utils.t('confirm_clear_2'))) {
                                store.clearVehicleLogs(id);
                                this.closeModal();
                            }
                        }, 50);
                    }
                }, 50);
            },

            deleteLog(id) {
                setTimeout(() => {
                    if(confirm(utils.t('confirm_delete'))) {
                        store.deleteLog(id);
                        this.closeModal();
                    }
                }, 50);
            },

            /* --- ACTIONS --- */
            
            exportJSON() {
                store.data.settings.lastBackupDate = Date.now();
                store.save();
                const dataStr = JSON.stringify(store.data, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            },

            importJSON() {
                setTimeout(() => {
                    if(confirm(utils.t('confirm_overwrite'))) {
                        document.getElementById('import-file').click();
                    }
                }, 50);
            },

            handleImport(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.vehicles && data.logs) {
                            store.data = data;
                            store.save();
                            alert(utils.t('import_success'));
                            window.location.reload();
                        } else {
                            alert(utils.t('import_error'));
                        }
                    } catch (err) {
                        alert(utils.t('import_error'));
                    }
                };
                reader.readAsText(file);
                input.value = ''; // Reset
            },

            exportCSV() {
                const logs = store.getVehicleLogs();
                const csvContent = "Date,Type,Odometer,Cost,Volume,Price/Unit,Notes,Location\n" + 
                    logs.map(l => `${l.date},${l.type},${l.odometer || ''},${l.cost},${l.liters || ''},${(l.cost/l.liters).toFixed(3) || ''},"${l.notes || ''}","${l.location || ''}"`).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "fuelmate_export.csv");
                document.body.appendChild(link);
                link.click();
            },
            
            openCalendarSelector() {
                this.openModal(`
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-4 theme-text-heading">${utils.t('export_cal_title')}</h2>
                        <p class="text-sm theme-text-sub mb-6">${utils.t('export_cal_desc')}</p>
                        <div class="space-y-3">
                            <button onclick="ui.openCalendarConfig('license')" class="w-full p-4 rounded-xl bg-purple-50 text-purple-700 font-bold flex items-center gap-3 hover:bg-purple-100 transition">
                                <span class="material-icons">badge</span> ${utils.t('license_renewal')}
                            </button>
                            <button onclick="ui.openCalendarConfig('insurance')" class="w-full p-4 rounded-xl bg-blue-50 text-blue-700 font-bold flex items-center gap-3 hover:bg-blue-100 transition">
                                <span class="material-icons">security</span> ${utils.t('insurance_renewal')}
                            </button>
                            <button onclick="ui.openCalendarConfig('registration')" class="w-full p-4 rounded-xl bg-teal-50 text-teal-700 font-bold flex items-center gap-3 hover:bg-teal-100 transition">
                                <span class="material-icons">directions_car</span> ${utils.t('registration')}
                            </button>
                        </div>
                        <button onclick="ui.closeModal()" class="w-full mt-6 py-3 text-slate-400 font-bold hover:text-slate-600">${utils.t('cancel')}</button>
                    </div>
                `);
            },
            
            openCalendarConfig(type) {
                const logs = store.getVehicleLogs();
                const latest = logs.filter(l => l.type === type).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                
                if (!latest || !latest.expiryDate) {
                    alert(utils.t('no_expiry_found'));
                    return;
                }

                const title = utils.t(type);
                this.openModal(`
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-2 theme-text-heading">${title}</h2>
                        <p class="text-sm theme-text-heading font-semibold mb-6">${utils.t('new_expiry')}: ${latest.expiryDate}</p>
                        <h3 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-3">${utils.t('reminder_option_title')}</h3>
                        <div class="space-y-2">
                            <button onclick="utils.exportCalendar('${title}', '${latest.expiryDate}', 0)" class="w-full p-3 rounded-xl bg-slate-50 text-slate-600 font-medium text-sm hover:bg-sky-50 hover:text-sky-600 transition text-left flex justify-between">
                                ${utils.t('reminder_none')} <span class="material-icons text-sm text-slate-300">notifications_off</span>
                            </button>
                            <button onclick="utils.exportCalendar('${title}', '${latest.expiryDate}', 0, true)" class="w-full p-3 rounded-xl bg-slate-50 text-slate-600 font-medium text-sm hover:bg-sky-50 hover:text-sky-600 transition text-left flex justify-between">
                                ${utils.t('reminder_on_day')} <span class="material-icons text-sm text-sky-400">event</span>
                            </button>
                            <button onclick="utils.exportCalendar('${title}', '${latest.expiryDate}', 7, true)" class="w-full p-3 rounded-xl bg-slate-50 text-slate-600 font-medium text-sm hover:bg-sky-50 hover:text-sky-600 transition text-left flex justify-between">
                                ${utils.t('reminder_1_week')} <span class="material-icons text-sm text-sky-400">notifications</span>
                            </button>
                            <button onclick="utils.exportCalendar('${title}', '${latest.expiryDate}', 30, true)" class="w-full p-3 rounded-xl bg-slate-50 text-slate-600 font-medium text-sm hover:bg-sky-50 hover:text-sky-600 transition text-left flex justify-between">
                                ${utils.t('reminder_1_month')} <span class="material-icons text-sm text-sky-400">history</span>
                            </button>
                        </div>
                        <button onclick="ui.openCalendarSelector()" class="w-full mt-4 text-slate-400 text-sm hover:text-slate-600">${utils.t('cancel')}</button>
                    </div>
                `);
            },

            openVehicleSelector() {
                const vehicles = store.data.vehicles;
                this.openModal(`
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-6 theme-text-heading">${utils.t('select_vehicle')}</h2>
                        <div class="space-y-3 max-h-60 overflow-y-auto">
                            ${vehicles.map(v => `
                                <button onclick="store.data.settings.activeVehicleId='${v.id}';store.save();ui.closeModal()" class="w-full p-4 rounded-xl border theme-border flex items-center gap-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition ${store.data.settings.activeVehicleId === v.id ? 'ring-2 ring-sky-500 bg-sky-50 dark:bg-sky-900/20' : ''}">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white ${utils.getCarColorClass(v)}">
                                        <span class="material-icons">${utils.getCarIcon(v)}</span>
                                    </div>
                                    <div class="text-left">
                                        <div class="font-bold theme-text-heading">${v.make} ${v.model}</div>
                                        <div class="text-xs theme-text-sub">${v.year}</div>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="ui.openAddVehicle();" class="w-full mt-4 py-3 bg-sky-500 text-white font-bold rounded-xl shadow">+ ${utils.t('add_vehicle')}</button>
                    </div>
                `);
            },

            openAboutModal() {
                this.openModal(`
                    <div class="p-6 text-center">
                         <div class="w-16 h-16 bg-gradient-to-br from-sky-400 to-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg mx-auto mb-4">
                            <span class="material-icons text-3xl">local_gas_station</span>
                        </div>
                        <h2 class="text-xl font-bold theme-text-heading">FuelMate</h2>
                        <p class="text-xs theme-text-sub mb-6">${utils.t('about_desc')}</p>
                        
                        <div class="text-left space-y-6 max-h-[50vh] overflow-y-auto pr-2">
                            <div>
                                <p class="text-sm theme-text-main leading-relaxed">${utils.t('about_intro')}</p>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-2">${utils.t('about_features')}</h4>
                                <ul class="text-sm theme-text-main space-y-1 list-disc pl-4">
                                    <li>${utils.t('feat_1')}</li>
                                    <li>${utils.t('feat_2')}</li>
                                    <li>${utils.t('feat_3')}</li>
                                    <li>${utils.t('feat_4')}</li>
                                    <li>${utils.t('feat_5')}</li>
                                </ul>
                            </div>
                             <div>
                                <h4 class="text-xs font-bold theme-text-sub uppercase tracking-widest mb-2">${utils.t('about_tech')}</h4>
                                <p class="text-sm theme-text-main leading-relaxed">${utils.t('tech_desc')}</p>
                            </div>
                        </div>

                        <button onclick="ui.closeModal()" class="w-full mt-6 py-3 bg-slate-100 dark:bg-slate-800 theme-text-heading font-bold rounded-xl hover:bg-slate-200 transition">${utils.t('cancel')}</button>
                    </div>
                `);
            }
        };

        /* --- UTILS EXTENSION FOR GEO & CALENDAR --- */
        utils.detectLocation = function(fieldId) {
            if (!navigator.geolocation) return alert('Geolocation not supported');
            const btn = document.querySelector(`[onclick="utils.detectLocation('${fieldId}')"]`);
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons animate-spin text-xs mr-1">refresh</span>Locating...';
            
            navigator.geolocation.getCurrentPosition(async pos => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                    const data = await res.json();
                    // Extract simple name: specific building/road, or suburb/city
                    let name = data.name || 
                               (data.address.road ? `${data.address.road}, ${data.address.suburb || data.address.city}` : '') ||
                               data.display_name.split(',')[0];
                               
                    document.getElementById(fieldId).value = name;
                } catch(e) {
                    document.getElementById(fieldId).value = `${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                }
                btn.innerHTML = originalText;
            }, () => {
                alert('Location access denied');
                btn.innerHTML = originalText;
            });
        };

        utils.exportCalendar = function(title, dateStr, alarmDays = 0, hasAlarm = false) {
            // Convert YYYY-MM-DD to YYYYMMDD
            const d = dateStr.replace(/-/g, '');
            let alarmBlock = '';
            
            if (hasAlarm) {
                // Calculate trigger time: -P[days]DT9H (9 AM on X days before)
                // Logic: TRIGGER:-P1W  (1 week before)
                let duration = 'P0D'; // On day
                if (alarmDays === 7) duration = 'P1W';
                if (alarmDays === 30) duration = 'P1M'; // iCal uses P1M? Or 30D. Let's use 4W or 30D safer. P30D.
                // Actually, simpler is explicit relative trigger
                let trigger = `-P${alarmDays}D`; 
                
                alarmBlock = `BEGIN:VALARM
TRIGGER:${trigger}
ACTION:DISPLAY
DESCRIPTION:FuelMate Reminder: ${title}
END:VALARM`;
            }

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//FuelMate//Vehicle Tracker//EN
BEGIN:VEVENT
UID:${Date.now()}@fuelmate.app
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART;VALUE=DATE:${d}
DTEND;VALUE=DATE:${d}
SUMMARY:FuelMate: ${title} Due
DESCRIPTION:Renew ${title} for your vehicle.
${alarmBlock}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'reminder.ics';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            ui.closeModal();
        };

        /* --- ROUTER --- */
        const router = {
            navigate(page) {
                ui.currentPage = page;
                ui.render();
            }
        };

        /* --- INIT --- */
        window.onload = () => {
            store.init();
            ui.render();
        };
    </script>
</body>
</html>